<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ClassQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      width: 400px;
    }
    button {
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: 0.3s;
    }
    button:hover { background: #3367D6; }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    h1 { font-size: 26px; margin-bottom: 20px; }
    .hidden { display: none; }
    #logoutBtn { background: #e74c3c; }
    #logoutBtn:hover { background: #c0392b; }
    .section {
      margin-top: 20px;
      text-align: left;
    }
  </style>
</head>
<body>

  <!-- ç™»å…¥ç•«é¢ -->
  <div class="card" id="loginCard">
    <h1>ClassQuest</h1>
    <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <!-- ä¸»ç•«é¢ -->
  <div class="card hidden" id="mainCard">
    <h1 id="welcomeText"></h1>
    <p id="roleText"></p>
    <div id="contentArea"></div>
    <button id="logoutBtn">ç™»å‡º</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
      authDomain: "classquest-419e1.firebaseapp.com",
      projectId: "classquest-419e1",
      storageBucket: "classquest-419e1.firebasestorage.app",
      messagingSenderId: "18905423391",
      appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
      measurementId: "G-0H7STZJVXS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const loginCard = document.getElementById("loginCard");
    const mainCard = document.getElementById("mainCard");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const welcomeText = document.getElementById("welcomeText");
    const roleText = document.getElementById("roleText");
    const contentArea = document.getElementById("contentArea");

    // ç™»å…¥
    loginBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          await setDoc(userRef, { email: user.email, role: "student" });
        }
      } catch (e) {
        alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
      }
    });

    // ç™»å‡º
    logoutBtn.addEventListener("click", async () => { await signOut(auth); });

    // ç‹€æ…‹ç›£è½
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginCard.classList.add("hidden");
        mainCard.classList.remove("hidden");
        welcomeText.textContent = `ğŸ‘‹ æ­¡è¿ï¼Œ${user.displayName}`;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        let role = "student";
        if (userSnap.exists()) role = userSnap.data().role;
        roleText.textContent = `æ‚¨çš„èº«åˆ†ï¼š${role}`;
        loadUI(role, user);
      } else {
        loginCard.classList.remove("hidden");
        mainCard.classList.add("hidden");
        contentArea.innerHTML = "";
      }
    });

    // æ ¹æ“šèº«åˆ†è¼‰å…¥ä»‹é¢
    async function loadUI(role, user) {
      contentArea.innerHTML = "";
      if (role === "admin") renderAdminUI();
      if (role === "teacher") renderTeacherUI(user);
      if (role === "student") renderStudentUI();
    }

    // ç®¡ç†è€…ä»‹é¢
    function renderAdminUI() {
      contentArea.innerHTML = `
        <div class="section">
          <h3>ç”¨æˆ¶ç®¡ç†</h3>
          <input type="text" id="emailInput" placeholder="è¼¸å…¥ Gmail">
          <select id="roleSelect">
            <option value="student">å­¸ç”Ÿ</option>
            <option value="teacher">è€å¸«</option>
            <option value="admin">ç®¡ç†è€…</option>
          </select>
          <button id="setRoleBtn">è¨­å®š</button>
        </div>`;
      document.getElementById("setRoleBtn").onclick = async () => {
        const email = document.getElementById("emailInput").value.trim();
        const newRole = document.getElementById("roleSelect").value;
        if (!email) return alert("è«‹è¼¸å…¥ Gmail");
        const usersSnap = await getDocs(collection(db, "users"));
        let found = false;
        for (const docSnap of usersSnap.docs) {
          if (docSnap.data().email === email) {
            await updateDoc(doc(db, "users", docSnap.id), { role: newRole });
            alert("å·²æ›´æ–°è§’è‰²");
            found = true;
            break;
          }
        }
        if (!found) alert("æ‰¾ä¸åˆ°è©²ä½¿ç”¨è€…");
      };
    }

    // è€å¸«ä»‹é¢
    function renderTeacherUI(user) {
      contentArea.innerHTML = `
        <div class="section">
          <h3>å»ºç«‹ç­ç´š</h3>
          <input type="text" id="className" placeholder="ç­ç´šåç¨±">
          <button id="createClassBtn">å»ºç«‹</button>
        </div>
        <div class="section">
          <h3>å‡ºé¡Œç³»çµ±</h3>
          <select id="levelSelect">
            <option value="">é¸æ“‡å­¸æ®µ</option>
            <option value="å°å­¸">åœ‹å°</option>
            <option value="åœ‹ä¸­">åœ‹ä¸­</option>
            <option value="é«˜ä¸­">é«˜ä¸­</option>
          </select>
          <select id="subjectSelect">
            <option value="">é¸æ“‡ç§‘ç›®</option>
          </select>
          <textarea id="questionContent" rows="4" placeholder="è¼¸å…¥é¡Œç›®å…§å®¹"></textarea>
          <button id="addQuestionBtn">å‡ºé¡Œ</button>
        </div>
      `;

      const subjectSelect = document.getElementById("subjectSelect");
      const levelSelect = document.getElementById("levelSelect");
      levelSelect.addEventListener("change", () => {
        const level = levelSelect.value;
        let subjects = [];
        if (level === "å°å­¸") subjects = ["åœ‹èª", "è‹±æ–‡", "æ•¸å­¸", "è‡ªç„¶", "ç¤¾æœƒ"];
        if (level === "åœ‹ä¸­") subjects = ["åœ‹èª", "è‹±æ–‡", "æ•¸å­¸", "ç”Ÿç‰©", "ç†åŒ–", "åœ°ç§‘", "æ­·å²", "åœ°ç†", "å…¬æ°‘"];
        if (level === "é«˜ä¸­") subjects = ["åœ‹èª", "è‹±æ–‡", "æ•¸å­¸", "ç”Ÿç‰©", "ç‰©ç†", "åŒ–å­¸", "åœ°ç§‘", "æ­·å²", "åœ°ç†", "å…¬æ°‘"];
        subjectSelect.innerHTML = `<option value="">é¸æ“‡ç§‘ç›®</option>` + subjects.map(s => `<option value="${s}">${s}</option>`).join("");
      });

      // å»ºç«‹ç­ç´š
      document.getElementById("createClassBtn").onclick = async () => {
        const name = document.getElementById("className").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
        await addDoc(collection(db, "classes"), { name, teacher: user.uid });
        alert("ç­ç´šå»ºç«‹æˆåŠŸï¼");
      };

      // å‡ºé¡Œ
      document.getElementById("addQuestionBtn").onclick = async () => {
        const level = levelSelect.value;
        const subject = subjectSelect.value;
        const content = document.getElementById("questionContent").value.trim();
        if (!level || !subject || !content) return alert("è«‹å®Œæ•´å¡«å¯«");
        await addDoc(collection(db, "questions"), { level, subject, content, teacher: user.uid });
        alert("å‡ºé¡ŒæˆåŠŸï¼");
      };
    }

    // å­¸ç”Ÿä»‹é¢
    function renderStudentUI() {
      contentArea.innerHTML = `<div class="section"><h3>å¾…å®Œæˆè©¦å·</h3><p>è€å¸«å‡ºçš„é¡Œç›®å°‡é¡¯ç¤ºåœ¨æ­¤ã€‚</p></div>`;
    }
  </script>
</body>
</html>
