<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>出題系統整合版</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f8f9fc;
  text-align: center;
  margin: 0;
  padding: 20px;
}
.card {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  max-width: 600px;
  margin: 20px auto;
}
input, select, textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
}
button {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
}
button:hover { background: #3730a3; }
.flex-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
</style>
</head>
<body>

<!-- 🔹 登入畫面 -->
<div id="loginDiv" class="card">
  <h2>登入系統</h2>
  <input type="email" id="loginEmail" placeholder="Email"><br><br>
  <input type="password" id="loginPassword" placeholder="密碼"><br><br>
  <button id="loginBtn">登入</button>
  <button id="registerBtn">註冊</button>
</div>

<!-- 🔹 老師頁面 -->
<div id="teacherPage" class="card" style="display:none;">
  <h2>班級管理</h2>

  <!-- 建立班級 -->
  <div class="flex-row" style="margin-bottom:15px;">
    <input type="text" id="newClassName" placeholder="輸入班級名稱" style="width:200px;">
    <button id="createClassBtn">建立班級</button>
  </div>

  <!-- 班級列表 -->
  <h3>你的班級</h3>
  <ul id="classList" style="list-style:none; padding:0;"></ul>

  <!-- 班級內頁 -->
  <div id="classPageDiv" class="card" style="display:none;">
    <h3 id="classTitle"></h3>

    <!-- 新增學生 -->
    <div class="flex-row" style="margin-bottom:10px;">
      <input type="text" id="studentName" placeholder="學生姓名" style="width:200px;">
      <button id="addStudentBtn">新增學生</button>
    </div>

    <!-- 出題系統 -->
    <h3>出題系統</h3>
    <input type="text" id="questionTitle" placeholder="題目名稱" style="width:300px;"><br><br>
    <textarea id="questionContent" placeholder="題目內容" style="width:300px; height:100px;"></textarea><br><br>

    <!-- 學制與科目 -->
    <div class="flex-row">
      <label>學制：</label>
      <select id="educationLevel" onchange="updateSubjects()">
        <option value="">請選擇學制</option>
        <option value="elementary">國小</option>
        <option value="junior">國中</option>
        <option value="senior">高中</option>
      </select>

      <label>科目：</label>
      <select id="subjectSelect">
        <option value="">請先選擇學制</option>
      </select>
    </div><br>

    <!-- 出題對象 -->
    <div class="flex-row">
      <label>出題對象：</label>
      <select id="questionTarget">
        <option value="all">全班</option>
        <option value="individual">個人</option>
      </select>
    </div><br>

    <button id="saveQuestionBtn">儲存題目</button>
  </div>
</div>

<!-- 🔹 學生頁面 -->
<div id="studentPage" class="card" style="display:none;">
  <h2>題目列表</h2>
  <div id="questionList"></div>
</div>

<!-- 🔹 Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

<script>
// 🔧 Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentClassId = null;

// 登入
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const email = loginEmail.value;
  const pass = loginPassword.value;
  auth.signInWithEmailAndPassword(email, pass).then(res=>{
    currentUser = res.user;
    loadRole();
  }).catch(e=>alert("登入失敗：" + e.message));
});

// 註冊
document.getElementById("registerBtn").addEventListener("click", ()=>{
  const email = loginEmail.value;
  const pass = loginPassword.value;
  auth.createUserWithEmailAndPassword(email, pass).then(res=>{
    db.collection("users").doc(res.user.uid).set({
      email,
      role: "student",
      name: email.split("@")[0]
    });
    alert("註冊成功！");
  }).catch(e=>alert("註冊失敗：" + e.message));
});

// 判斷身份進入畫面
function loadRole(){
  db.collection("users").doc(currentUser.uid).get().then(doc=>{
    if(!doc.exists) return alert("無此使用者資料");
    const role = doc.data().role;
    loginDiv.style.display = "none";
    if(role === "teacher") loadTeacherPage(currentUser.uid);
    else loadStudentPage(currentUser.uid);
  });
}

// ---------------- 老師系統 ----------------
const classList = document.getElementById('classList');
const classPageDiv = document.getElementById('classPageDiv');
const classTitle = document.getElementById('classTitle');

function loadTeacherPage(uid){
  teacherPage.style.display = "block";
  loadTeacherClasses(uid);
}

function loadTeacherClasses(uid){
  classList.innerHTML = "";
  db.collection("classes").where("teacherId","==",uid).get().then(snap=>{
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.innerHTML = `<button onclick="openClassPage('${doc.id}','${doc.data().name}')">${doc.data().name}</button>`;
      classList.appendChild(li);
    });
  });
}

// 建立班級
createClassBtn.addEventListener("click", ()=>{
  const name = newClassName.value.trim();
  if(!name) return alert("請輸入班級名稱");
  db.collection("classes").add({ name, teacherId: currentUser.uid }).then(()=>{
    alert("班級建立成功");
    loadTeacherClasses(currentUser.uid);
    newClassName.value = "";
  });
});

function openClassPage(id, name){
  currentClassId = id;
  classPageDiv.style.display = "block";
  classTitle.innerText = name;
}

// 新增學生
addStudentBtn.addEventListener("click", ()=>{
  const name = studentName.value.trim();
  if(!name) return alert("請輸入學生姓名");
  db.collection("users").add({
    name, email:"", role:"student", classId: currentClassId
  }).then(()=>alert("學生新增成功")).catch(e=>alert(e.message));
  studentName.value = "";
});

// 學制科目動態
function updateSubjects(){
  const edu = educationLevel.value;
  const map = {
    elementary:["國語","英文","數學","自然","社會"],
    junior:["國語","英文","數學","生物","理化","地科","歷史","地理","公民"],
    senior:["國語","英文","數學","生物","物理","化學","地科","歷史","地理","公民"]
  };
  subjectSelect.innerHTML = "";
  if(!map[edu]) return subjectSelect.innerHTML=`<option>請先選學制</option>`;
  map[edu].forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    subjectSelect.appendChild(opt);
  });
}

// 儲存題目
saveQuestionBtn.addEventListener("click", ()=>{
  const title = questionTitle.value.trim();
  const content = questionContent.value.trim();
  const edu = educationLevel.value;
  const sub = subjectSelect.value;
  const target = questionTarget.value;
  if(!title||!content||!edu||!sub) return alert("請完整填寫");
  db.collection("questions").add({
    title, content, edu, sub, target,
    teacherId: currentUser.uid, classId: currentClassId,
    timestamp: Date.now()
  }).then(()=>alert("題目已儲存"));
  questionTitle.value = questionContent.value = "";
});

// ---------------- 學生系統 ----------------
function loadStudentPage(uid){
  studentPage.style.display = "block";
  db.collection("users").doc(uid).get().then(doc=>{
    const classId = doc.data().classId;
    if(!classId) return alert("尚未分配班級");
    db.collection("questions").where("classId","==",classId).get().then(snap=>{
      const list = document.getElementById("questionList");
      list.innerHTML = "";
      snap.forEach(q=>{
        const d = q.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h4>${d.title}</h4><p>${d.content}</p><small>${d.edu} - ${d.sub}</small>`;
        list.appendChild(div);
      });
    });
  });
}
</script>
</body>
</html>
