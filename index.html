<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassQuest å®Œæ•´ç³»çµ±</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
<style>
body {
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background: linear-gradient(135deg,#f5f6fa,#e9ecef);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  padding:40px 0;
}
.card {
  background:#fff;
  border-radius:16px;
  box-shadow:0 4px 16px rgba(0,0,0,0.1);
  width:450px;
  max-width:95%;
  padding:30px;
  margin:15px auto;
  text-align:center;
  transition:0.3s;
}
.card:hover { box-shadow:0 6px 20px rgba(0,0,0,0.15);}
button {
  width:100%;
  padding:10px 16px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#4285F4;
  color:#fff;
  cursor:pointer;
  margin-top:10px;
  transition:0.3s;
}
button:hover { background:#3367D6; }
#logoutBtn { background:#e74c3c; }
#logoutBtn:hover { background:#c0392b; }
input, select, textarea {
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
h1,h2,h3,h4 { margin:10px 0; }
ul { padding:0; list-style:none; }
li { background:#f8f9fa; margin:6px 0; padding:8px; border-radius:8px; cursor:pointer; transition:0.2s; }
li:hover { background:#e2e6ea; }
.hidden { display:none; }
.section { text-align:left; margin-top:20px; }
textarea { resize:none; }
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1>ClassQuest</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div class="card hidden" id="mainCard">
  <h2 id="welcomeText"></h2>
  <p id="roleText"></p>
  <div id="contentArea"></div>
  <button id="logoutBtn">ç™»å‡º</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain:"classquest-419e1.firebaseapp.com",
  projectId:"classquest-419e1",
  storageBucket:"classquest-419e1.firebasestorage.app",
  messagingSenderId:"18905423391",
  appId:"1:18905423391:web:37c3aa41f021430f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginCard = document.getElementById("loginCard");
const mainCard = document.getElementById("mainCard");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const welcomeText = document.getElementById("welcomeText");
const roleText = document.getElementById("roleText");
const contentArea = document.getElementById("contentArea");

loginBtn.addEventListener("click", async ()=>{
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      await setDoc(userRef,{email:user.email,name:user.displayName,role:"student"});
    }
  }catch(e){alert("ç™»å…¥å¤±æ•—ï¼š"+e.message);}
});

logoutBtn.addEventListener("click", async ()=>{ await signOut(auth); });

onAuthStateChanged(auth, async (user)=>{
  if(user){
    loginCard.classList.add("hidden");
    mainCard.classList.remove("hidden");
    welcomeText.textContent = `ğŸ‘‹ æ­¡è¿ï¼Œ${user.displayName}`;
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    let role = "student";
    if(userSnap.exists()) role = userSnap.data().role;
    roleText.textContent = `èº«åˆ†ï¼š${role}`;
    loadUI(role,user);
  }else{
    loginCard.classList.remove("hidden");
    mainCard.classList.add("hidden");
    contentArea.innerHTML="";
  }
});

async function loadUI(role,user){
  contentArea.innerHTML="";
  if(role==="admin") renderAdminUI();
  if(role==="teacher") renderTeacherUI(user);
  if(role==="student") renderStudentUI(user);
}

// ----------------- Admin å…¨ç¸£ç‰ˆ -----------------
async function renderAdminUI(){
  contentArea.innerHTML=`
    <div class="section">
      <h3>ç”¨æˆ¶ç®¡ç†</h3>
      <input type="text" id="emailInput" placeholder="è¼¸å…¥ Gmail">
      <select id="roleSelect">
        <option value="student">å­¸ç”Ÿ</option>
        <option value="teacher">è€å¸«</option>
        <option value="admin">ç®¡ç†è€…</option>
      </select>
      <button id="setRoleBtn">è¨­å®š</button>
    </div>
    <div class="section">
      <h3>å…¨ç¸£è€å¸«åŠç­ç´š</h3>
      <ul id="allTeacherList"></ul>
    </div>
    <div class="section">
      <h3>æ‰€æœ‰ç­ç´šå­¸ç”Ÿ</h3>
      <ul id="allClassList"></ul>
    </div>
  `;

  const setRoleBtn = document.getElementById("setRoleBtn");
  setRoleBtn.onclick = async ()=>{
    const email = document.getElementById("emailInput").value.trim();
    const newRole = document.getElementById("roleSelect").value;
    if(!email) return alert("è«‹è¼¸å…¥ Gmail");

    const usersSnap = await getDocs(collection(db,"users"));
    let found=false;
    for(const docSnap of usersSnap.docs){
      if(docSnap.data().email === email){
        await updateDoc(doc(db,"users",docSnap.id),{role:newRole});
        alert("è§’è‰²æ›´æ–°å®Œæˆï¼");
        found=true;
        break;
      }
    }
    if(!found) alert("æ‰¾ä¸åˆ°è©²ä½¿ç”¨è€…");
    loadAllTeachers();
  };

  async function loadAllTeachers(){
    const allTeacherList = document.getElementById("allTeacherList");
    allTeacherList.innerHTML = "";
    const usersSnap = await getDocs(collection(db,"users"));
    for(const docSnap of usersSnap.docs){
      const u = docSnap.data();
      if(u.role==="teacher"){
        const li = document.createElement("li");
        li.textContent = `${u.name} (${u.email})`;
        li.style.cursor="pointer";
        li.onclick = ()=> loadTeacherClasses(docSnap.id);
        allTeacherList.appendChild(li);
      }
    }
  }

  async function loadTeacherClasses(teacherId){
    const allClassList = document.getElementById("allClassList");
    allClassList.innerHTML = "";
    const q = query(collection(db,"classes"), where("teacherId","==",teacherId));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap=>{
      const li = document.createElement("li");
      li.textContent = docSnap.data().name;
      li.style.cursor="pointer";
      li.onclick = ()=> loadClassStudents(docSnap.id, docSnap.data().name);
      allClassList.appendChild(li);
    });
  }

  async function loadClassStudents(classId,className){
    const ul = document.getElementById("allClassList");
    ul.innerHTML = `<li><b>${className} ç­å­¸ç”Ÿåå–®</b></li>`;
    const usersSnap = await getDocs(collection(db,"users"));
    usersSnap.forEach(docSnap=>{
      const u = docSnap.data();
      if(u.classId===classId){
        const li = document.createElement("li");
        li.textContent = u.name + " (" + u.email + ")";
        ul.appendChild(li);
      }
    });
  }

  loadAllTeachers();
}

// ----------------- Teacher -----------------
async function renderTeacherUI(user){
  contentArea.innerHTML=`
    <div class="section">
      <h3>ç­ç´šç®¡ç†</h3>
      <input type="text" id="className" placeholder="è¼¸å…¥ç­ç´šåç¨±">
      <button id="createClassBtn">å»ºç«‹ç­ç´š</button>
      <ul id="classList"></ul>
    </div>

    <div id="rangeSection" class="section hidden">
      <h3>é¸æ“‡å‡ºé¡Œç¯„åœ</h3>
      <select id="levelSelect">
        <option value="">é¸æ“‡å­¸æ®µ</option>
        <option value="åœ‹å°">åœ‹å°</option>
        <option value="åœ‹ä¸­">åœ‹ä¸­</option>
        <option value="é«˜ä¸­">é«˜ä¸­</option>
      </select>
      <select id="subjectSelect"><option value="">é¸æ“‡ç§‘ç›®</option></select>
      <select id="classSelect"><option value="">é¸æ“‡ç­ç´š</option></select>
      <select id="studentSelect"><option value="">é¸æ“‡å­¸ç”Ÿ(å…¨ç­å¯ç•™ç©º)</option></select>
      <button id="confirmRangeBtn">ç¢ºå®šç¯„åœ</button>
    </div>

    <div id="questionSection" class="section hidden">
      <h3>å‡ºé¡Œå…§å®¹</h3>
      <textarea id="questionContent" rows="3" placeholder="è¼¸å…¥é¡Œç›®å…§å®¹"></textarea>
      <input type="text" id="correctAnswer" placeholder="æ­£ç¢ºç­”æ¡ˆ">
      <textarea id="explanation" rows="2" placeholder="è§£é‡‹"></textarea>
      <button id="addQuestionBtn">å‡ºé¡Œ</button>
    </div>
  `;

  const classList=document.getElementById("classList");
  let currentClassId="";
  let selectedRange={};

  document.getElementById("createClassBtn").onclick=async ()=>{
    const name=document.getElementById("className").value.trim();
    if(!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
    await addDoc(collection(db,"classes"),{name,teacherId:user.uid});
    alert("ç­ç´šå»ºç«‹æˆåŠŸï¼");
    loadClasses();
  };

  async function loadClasses(){
    classList.innerHTML="";
    const q=query(collection(db,"classes"),where("teacherId","==",user.uid));
    const snapshot=await getDocs(q);
    const classSelect=document.getElementById("classSelect");
    classSelect.innerHTML=`<option value="">é¸æ“‡ç­ç´š</option>`;
    snapshot.forEach(docSnap=>{
      const li=document.createElement("li");
      li.textContent=docSnap.data().name;
      li.onclick=()=>{ currentClassId=docSnap.id; alert(`é¸æ“‡ç­ç´š: ${docSnap.data().name}`); };
      classList.appendChild(li);
      classSelect.innerHTML+=`<option value="${docSnap.id}">${docSnap.data().name}</option>`;
    });
  }

  document.getElementById("levelSelect").addEventListener("change",()=>{
    const level=document.getElementById("levelSelect").value;
    let subjects=[];
    if(level==="åœ‹å°") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","è‡ªç„¶","ç¤¾æœƒ"];
    if(level==="åœ‹ä¸­") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç†åŒ–","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"];
    if(level==="é«˜ä¸­") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç‰©ç†","åŒ–å­¸","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"];
    document.getElementById("subjectSelect").innerHTML=`<option value="">é¸æ“‡ç§‘ç›®</option>`+subjects.map(s=>`<option value="${s}">${s}</option>`).join("");
  });

  document.getElementById("confirmRangeBtn").onclick=async ()=>{
    const level=document.getElementById("levelSelect").value;
    const subject=document.getElementById("subjectSelect").value;
    const classId=document.getElementById("classSelect").value;
    const student=document.getElementById("studentSelect").value;
    if(!level||!subject||!classId) return alert("è«‹å®Œæ•´é¸æ“‡ç¯„åœ");
    selectedRange={level,subject,classId,student};
    document.getElementById("questionSection").classList.remove("hidden");
    alert(`å·²é¸ç¯„åœ: ${level} ${subject}`);
  };

  document.getElementById("addQuestionBtn").onclick=async ()=>{
    const content=document.getElementById("questionContent").value.trim();
    const correct=document.getElementById("correctAnswer").value.trim();
    const explanation=document.getElementById("explanation").value.trim();
    if(!content||!correct||!explanation) return alert("è«‹å®Œæ•´å¡«å¯«é¡Œç›®ã€ç­”æ¡ˆèˆ‡è§£é‡‹");
    await addDoc(collection(db,"questions"),{
      ...selectedRange,
      content,
      correctAnswer: correct,
      explanation,
      teacherId:user.uid,
      timestamp:Date.now()
    });
    alert("å‡ºé¡ŒæˆåŠŸï¼");
    document.getElementById("questionContent").value="";
    document.getElementById("correctAnswer").value="";
    document.getElementById("explanation").value="";
  };

  loadClasses();
}

// ----------------- Student -----------------
async function renderStudentUI(user){
  contentArea.innerHTML=`<div class="section"><h3>ä½ çš„è©¦å·</h3><ul id="testList"></ul></div>`;
  const testList=document.getElementById("testList");
  const snapshot=await getDocs(collection(db,"questions"));
  snapshot.forEach(docSnap=>{
    const q=docSnap.data();
    if(q.student===user.uid||!q.student) {
      const li=document.createElement("li");
      li.innerHTML=`<b>${q.level} ${q.subject}</b><br>${q.content}<br><b>ç­”æ¡ˆ:</b> ${q.correctAnswer}<br><b>è§£é‡‹:</b> ${q.explanation}`;
      testList.appendChild(li);
    }
  });
}
</script>

</body>
</html>
