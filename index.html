<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassQuest 全功能系統</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
<style>
body{font-family:"Segoe UI",sans-serif;background:#f5f6fa;display:flex;justify-content:center;padding:20px;}
.card{background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);width:500px;padding:30px;text-align:center;margin-bottom:20px;}
button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:8px;background:#4285F4;color:#fff;cursor:pointer;font-size:16px;}
button:hover{background:#3367D6;}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;}
ul{list-style:none;padding:0;}
li{padding:8px;background:#f8f9fa;margin:6px 0;border-radius:8px;cursor:pointer;}
li:hover{background:#e2e6ea;}
.hidden{display:none;}
.section{margin-top:20px;text-align:left;}
textarea{resize:none;}
.option-btn{margin-top:5px;}
.correct{color:green;font-weight:bold;}
.wrong{color:red;font-weight:bold;}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1>ClassQuest 系統</h1>
  <button id="loginBtn">使用 Google 登入</button>
</div>

<div class="card hidden" id="mainCard">
  <h2 id="welcomeText"></h2>
  <p id="roleText"></p>
  <div id="contentArea"></div>
  <button id="logoutBtn">登出</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain:"classquest-419e1.firebaseapp.com",
  projectId:"classquest-419e1",
  storageBucket:"classquest-419e1.firebasestorage.app",
  messagingSenderId:"18905423391",
  appId:"1:18905423391:web:37c3aa41f021430"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginCard=document.getElementById("loginCard");
const mainCard=document.getElementById("mainCard");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const welcomeText=document.getElementById("welcomeText");
const roleText=document.getElementById("roleText");
const contentArea=document.getElementById("contentArea");

// 登入登出
loginBtn.addEventListener("click", async ()=>{
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      await setDoc(userRef,{email:user.email,name:user.displayName,role:"teacher",classId:null});
    }
  }catch(e){alert("登入失敗："+e.message);}
});
logoutBtn.addEventListener("click", async ()=>{await signOut(auth);});

// 監聽登入狀態
onAuthStateChanged(auth, async user=>{
  if(user){
    loginCard.classList.add("hidden");
    mainCard.classList.remove("hidden");
    const userSnap = await getDoc(doc(db,"users",user.uid));
    const role = userSnap.exists()?userSnap.data().role:"student";
    welcomeText.textContent=`👋 歡迎，${user.displayName}`;
    roleText.textContent=`身分：${role}`;
    if(role==="admin") renderAdminUI(user);
    else if(role==="teacher") renderTeacherUI(user);
    else renderStudentUI(user);
  }else{
    loginCard.classList.remove("hidden");
    mainCard.classList.add("hidden");
    contentArea.innerHTML="";
  }
});

// ---------------- 管理者 ----------------
async function renderAdminUI(user){
  contentArea.innerHTML=`
    <div class="section"><h3>用戶管理</h3>
      <input type="email" id="newUserEmail" placeholder="輸入 Gmail">
      <select id="newUserRole"><option value="student">學生</option><option value="teacher">老師</option><option value="admin">管理者</option></select>
      <button id="addUserBtn">設定</button>
      <ul id="userList"></ul>
    </div>
    <div class="section"><h3>班級管理</h3>
      <input type="text" id="className" placeholder="輸入班級名稱">
      <button id="createClassBtn">建立班級</button>
      <ul id="classList"></ul>
    </div>
  `;
  document.getElementById("addUserBtn").onclick=async ()=>{
    const email=document.getElementById("newUserEmail").value.trim();
    const role=document.getElementById("newUserRole").value;
    if(!email) return alert("請輸入 Gmail");
    await addDoc(collection(db,"users"),{email,name:"使用者",role,classId:null});
    alert("用戶已新增/更新");
    loadAdminUsers();
  };
  async function loadAdminUsers(){
    const ul=document.getElementById("userList"); ul.innerHTML="";
    const snapshot = await getDocs(collection(db,"users"));
    snapshot.forEach(docSnap=>{
      const u=docSnap.data();
      const li=document.createElement("li");
      li.textContent=`${u.name} (${u.email}) - ${u.role}`;
      ul.appendChild(li);
    });
  }
  loadAdminUsers();

  document.getElementById("createClassBtn").onclick=async ()=>{
    const name=document.getElementById("className").value.trim();
    if(!name) return alert("請輸入班級名稱");
    await addDoc(collection(db,"classes"),{name,teacherId:null});
    alert("班級建立成功");
    loadAdminClasses();
  };
  async function loadAdminClasses(){
    const ul=document.getElementById("classList"); ul.innerHTML="";
    const snapshot = await getDocs(collection(db,"classes"));
    snapshot.forEach(docSnap=>{
      const cls=docSnap.data();
      const li=document.createElement("li");
      li.textContent=`${cls.name} - ${cls.teacherId?cls.teacherId:"無老師"}`;
      ul.appendChild(li);
    });
  }
  loadAdminClasses();
}

// ---------------- 老師 ----------------
async function renderTeacherUI(user){
  contentArea.innerHTML=`
    <div class="section"><h3>班級管理</h3>
      <input type="text" id="className" placeholder="輸入班級名稱">
      <button id="createClassBtn">建立班級</button>
      <ul id="classList"></ul>
    </div>
    <div id="classSection" class="section hidden">
      <h3 id="classTitle"></h3>
      <input type="email" id="studentEmail" placeholder="學生 Gmail">
      <button id="addStudentBtn">新增學生</button>
      <ul id="studentList"></ul>

      <div class="section">
        <h4>新增選擇題</h4>
        <textarea id="questionContent" rows="2" placeholder="題目內容"></textarea>
        <input type="text" id="optA" placeholder="選項 A">
        <input type="text" id="optB" placeholder="選項 B">
        <input type="text" id="optC" placeholder="選項 C">
        <input type="text" id="optD" placeholder="選項 D">
        <select id="correctAnswer"><option value="">選擇正確答案</option>
          <option value="A">A</option><option value="B">B</option>
          <option value="C">C</option><option value="D">D</option>
        </select>
        <textarea id="explanation" rows="2" placeholder="解釋"></textarea>
        <button id="addQuestionBtn">出題</button>
      </div>

      <div class="section">
        <h4>學生作答</h4>
        <ul id="studentQuizList"></ul>
      </div>
    </div>
  `;

  const classList=document.getElementById("classList");
  const classSection=document.getElementById("classSection");
  let currentClassId="";

  document.getElementById("createClassBtn").onclick=async ()=>{
    const name=document.getElementById("className").value.trim();
    if(!name) return alert("請輸入班級名稱");
    const docRef=await addDoc(collection(db,"classes"),{name,teacherId:user.uid});
    currentClassId=docRef.id;
    alert("班級建立成功！");
    loadClasses();
  };

  async function loadClasses(){
    classList.innerHTML="";
    const q=query(collection(db,"classes"),where("teacherId","==",user.uid));
    const snapshot=await getDocs(q);
    snapshot.forEach(docSnap=>{
      const li=document.createElement("li");
      li.textContent=docSnap.data().name;
      li.onclick=()=>{currentClassId=docSnap.id; openClass(docSnap.data().name);};
      classList.appendChild(li);
    });
  }

  function openClass(name){
    classSection.classList.remove("hidden");
    document.getElementById("classTitle").textContent=name;
    loadStudents();
    loadStudentQuiz();
  }

  async function loadStudents(){
    const ul=document.getElementById("studentList"); ul.innerHTML="";
    const snapshot=await getDocs(collection(db,"users"));
    snapshot.forEach(docSnap=>{
      const u=docSnap.data();
      if(u.classId===currentClassId){
        const li=document.createElement("li");
        li.textContent=`${u.name} (${u.email})`;
        ul.appendChild(li);
      }
    });
  }

  document.getElementById("addStudentBtn").onclick=async ()=>{
    const email=document.getElementById("studentEmail").value.trim();
    if(!email) return alert("請輸入 Gmail");
    await addDoc(collection(db,"users"),{email,name:"學生",role:"student",classId:currentClassId});
    alert("學生新增成功！");
    loadStudents();
  };

  document.getElementById("addQuestionBtn").onclick=async ()=>{
    const content=document.getElementById("questionContent").value.trim();
    const optA=document.getElementById("optA").value.trim();
    const optB=document.getElementById("optB").value.trim();
    const optC=document.getElementById("optC").value.trim();
    const optD=document.getElementById("optD").value.trim();
    const correct=document.getElementById("correctAnswer").value;
    const explanation=document.getElementById("explanation").value.trim();
    if(!content||!optA||!optB||!optC||!optD||!correct||!explanation) return alert("請完整填寫題目與選項");
    await addDoc(collection(db,"questions"),{content,optA,optB,optC,optD,correctAnswer:correct,explanation,classId:currentClassId,teacherId:user.uid});
    alert("題目已新增！");
    loadStudentQuiz();
  };

  async function loadStudentQuiz(){
    const ul=document.getElementById("studentQuizList"); ul.innerHTML="";
    const q=query(collection(db,"questions"),where("classId","==",currentClassId));
    const snapshot=await getDocs(q);
    snapshot.forEach(docSnap=>{
      const qData=docSnap.data();
      const li=document.createElement("li");
      li.innerHTML=`${qData.content} <br> A:${qData.optA} B:${qData.optB} C:${qData.optC} D:${qData.optD} <br> 正確答案:${qData.correctAnswer}`;
      ul.appendChild(li);
    });
  }

  loadClasses();
}

// ---------------- 學生 ----------------
async function renderStudentUI(user){
  contentArea.innerHTML=`<div class="section"><h3>你的班級作答題目</h3><ul id="quizList"></ul></div>`;
  const ul=document.getElementById("quizList"); ul.innerHTML="";
  const snapshot=await getDocs(collection(db,"questions"));
  snapshot.forEach(docSnap=>{
    const q=docSnap.data();
    const li=document.createElement("li");
    li.innerHTML=`${q.content}<br>
      <button class="option-btn" onclick="answer('${docSnap.id}','A')">A:${q.optA}</button>
      <button class="option-btn" onclick="answer('${docSnap.id}','B')">B:${q.optB}</button>
      <button class="option-btn" onclick="answer('${docSnap.id}','C')">C:${q.optC}</button>
      <button class="option-btn" onclick="answer('${docSnap.id}','D')">D:${q.optD}</button>
      <p id="ans-${docSnap.id}"></p>`;
    ul.appendChild(li);
  });

  window.answer=async (qId,choice)=>{
    const qRef=doc(db,"questions",qId);
    const qSnap=await getDoc(qRef);
    const correct=qSnap.data().correctAnswer;
    const explanation=qSnap.data().explanation;
    const p=document.getElementById(`ans-${qId}`);
    if(choice===correct) p.innerHTML=`✅ 正確！<br>${explanation}`;
    else p.innerHTML=`❌ 錯誤！正確答案：${correct}<br>${explanation}`;
    await addDoc(collection(db,"answers"),{studentId:user.uid,questionId:qId,selected:choice,correct:choice===correct,timestamp:Date.now()});
  };
}

</script>
</body>
</html>
