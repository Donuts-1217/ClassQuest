<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ClassQuest</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f8f9fc;
  text-align: center;
  margin: 0;
  padding: 20px;
}
.card {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  max-width: 600px;
  margin: 40px auto;
}
input, select, textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
}
button {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
}
button:hover { background: #3730a3; }
.flex-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
</style>
</head>
<body>

<!-- ğŸ”¹ ç™»å…¥ç•«é¢ -->
<div id="loginDiv" class="card">
  <h2>ç™»å…¥ç³»çµ±</h2>
  <p>è«‹ä½¿ç”¨ Google ç™»å…¥</p>
  <button id="googleLoginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<!-- ğŸ”¹ è€å¸«é é¢ -->
<div id="teacherPage" class="card" style="display:none;">
  <h2>ç­ç´šç®¡ç†</h2>
  <div class="flex-row">
    <input type="text" id="newClassName" placeholder="è¼¸å…¥ç­ç´šåç¨±" style="width:200px;">
    <button id="createClassBtn">å»ºç«‹ç­ç´š</button>
  </div>
  <h3>ä½ çš„ç­ç´š</h3>
  <ul id="classList" style="list-style:none; padding:0;"></ul>

  <!-- ç­ç´šå…§é  -->
  <div id="classPageDiv" class="card" style="display:none;">
    <h3 id="classTitle"></h3>

    <div class="flex-row" style="margin-bottom:10px;">
      <input type="text" id="studentEmail" placeholder="å­¸ç”Ÿ Gmail" style="width:200px;">
      <button id="addStudentBtn">æ–°å¢å­¸ç”Ÿ</button>
    </div>

    <h3>å‡ºé¡Œç³»çµ±</h3>
    <input type="text" id="questionTitle" placeholder="é¡Œç›®åç¨±" style="width:300px;"><br><br>
    <textarea id="questionContent" placeholder="é¡Œç›®å…§å®¹" style="width:300px; height:100px;"></textarea><br><br>

    <div class="flex-row">
      <label>å­¸åˆ¶ï¼š</label>
      <select id="educationLevel" onchange="updateSubjects()">
        <option value="">è«‹é¸æ“‡å­¸åˆ¶</option>
        <option value="elementary">åœ‹å°</option>
        <option value="junior">åœ‹ä¸­</option>
        <option value="senior">é«˜ä¸­</option>
      </select>

      <label>ç§‘ç›®ï¼š</label>
      <select id="subjectSelect">
        <option value="">è«‹å…ˆé¸æ“‡å­¸åˆ¶</option>
      </select>
    </div><br>

    <div class="flex-row">
      <label>å‡ºé¡Œå°è±¡ï¼š</label>
      <select id="questionTarget">
        <option value="all">å…¨ç­</option>
        <option value="individual">å€‹äºº</option>
      </select>
    </div><br>

    <button id="saveQuestionBtn">å„²å­˜é¡Œç›®</button>
  </div>
</div>

<!-- ğŸ”¹ å­¸ç”Ÿé é¢ -->
<div id="studentPage" class="card" style="display:none;">
  <h2>é¡Œç›®åˆ—è¡¨</h2>
  <div id="questionList"></div>
</div>

<!-- ğŸ”¹ ç®¡ç†è€…é é¢ -->
<div id="adminPage" class="card" style="display:none;">
  <h2>ç”¨æˆ¶ç®¡ç†</h2>
  <div class="flex-row">
    <input type="email" id="manageEmail" placeholder="è¼¸å…¥ Gmail">
    <select id="roleSelect">
      <option value="student">å­¸ç”Ÿ</option>
      <option value="teacher">è€å¸«</option>
      <option value="admin">ç®¡ç†è€…</option>
    </select>
    <button id="setRoleBtn">è¨­å®š</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentClassId = null;

// ğŸ”¹ Google ç™»å…¥
document.getElementById("googleLoginBtn").addEventListener("click", async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    currentUser = user;
    const userRef = db.collection("users").doc(user.uid);
    const docSnap = await userRef.get();
    if(!docSnap.exists){
      await userRef.set({
        email: user.email,
        role: "student"
      });
    }
    loadRole();
  } catch (e) {
    alert("ç™»å…¥å¤±æ•—ï¼š" + e.message);
  }
});

// ğŸ”¹ è®€å–è§’è‰²
async function loadRole(){
  const userDoc = await db.collection("users").doc(currentUser.uid).get();
  if(!userDoc.exists) return alert("æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™");
  const role = userDoc.data().role;
  loginDiv.style.display = "none";
  if(role === "teacher") loadTeacherPage();
  else if(role === "admin") loadAdminPage();
  else loadStudentPage();
}

// ğŸ”¹ ç®¡ç†è€…é é¢
function loadAdminPage(){
  adminPage.style.display = "block";
  document.getElementById("setRoleBtn").onclick = async ()=>{
    const email = manageEmail.value.trim();
    const role = roleSelect.value;
    if(!email) return alert("è«‹è¼¸å…¥ Gmail");
    const users = await db.collection("users").where("email","==",email).get();
    if(users.empty) return alert("æ‰¾ä¸åˆ°è©²å¸³è™Ÿ");
    users.forEach(doc=>{
      db.collection("users").doc(doc.id).update({role});
    });
    alert("è¨­å®šå®Œæˆï¼");
  };
}

// ğŸ”¹ è€å¸«é é¢
function loadTeacherPage(){
  teacherPage.style.display = "block";
  loadTeacherClasses();
}

// å»ºç«‹ç­ç´š
createClassBtn.addEventListener("click", async ()=>{
  const name = newClassName.value.trim();
  if(!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
  await db.collection("classes").add({
    name,
    teacherId: currentUser.uid
  });
  alert("ç­ç´šå»ºç«‹æˆåŠŸ");
  loadTeacherClasses();
  newClassName.value="";
});

// è¼‰å…¥è€å¸«ç­ç´š
async function loadTeacherClasses(){
  classList.innerHTML = "";
  const snap = await db.collection("classes").where("teacherId","==",currentUser.uid).get();
  snap.forEach(doc=>{
    const li = document.createElement("li");
    li.innerHTML = `<button onclick="openClass('${doc.id}','${doc.data().name}')">${doc.data().name}</button>`;
    classList.appendChild(li);
  });
}

// é–‹å•Ÿç­ç´š
function openClass(id,name){
  currentClassId = id;
  classPageDiv.style.display="block";
  classTitle.innerText=name;
}

// æ–°å¢å­¸ç”Ÿ
addStudentBtn.addEventListener("click", async ()=>{
  const email = studentEmail.value.trim();
  if(!email) return alert("è«‹è¼¸å…¥å­¸ç”Ÿ Gmail");
  const snap = await db.collection("users").where("email","==",email).get();
  if(snap.empty) return alert("æ‰¾ä¸åˆ°è©²å¸³è™Ÿ");
  snap.forEach(doc=>{
    db.collection("users").doc(doc.id).update({classId:currentClassId});
  });
  alert("å­¸ç”Ÿå·²åŠ å…¥ç­ç´šï¼");
  studentEmail.value="";
});

// å­¸åˆ¶ç§‘ç›®
function updateSubjects(){
  const edu = educationLevel.value;
  const map = {
    elementary:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","è‡ªç„¶","ç¤¾æœƒ"],
    junior:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç†åŒ–","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"],
    senior:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç‰©ç†","åŒ–å­¸","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"]
  };
  subjectSelect.innerHTML = "";
  if(!map[edu]) return subjectSelect.innerHTML=`<option>è«‹å…ˆé¸å­¸åˆ¶</option>`;
  map[edu].forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s; opt.textContent=s;
    subjectSelect.appendChild(opt);
  });
}

// å„²å­˜é¡Œç›®
saveQuestionBtn.addEventListener("click", async ()=>{
  const title=questionTitle.value.trim();
  const content=questionContent.value.trim();
  const edu=educationLevel.value;
  const sub=subjectSelect.value;
  const target=questionTarget.value;
  if(!title||!content||!edu||!sub) return alert("è«‹å®Œæ•´å¡«å¯«");
  await db.collection("questions").add({
    title,content,edu,sub,target,
    teacherId:currentUser.uid,classId:currentClassId,
    timestamp:Date.now()
  });
  alert("é¡Œç›®å·²å„²å­˜");
  questionTitle.value = questionContent.value="";
});

// ğŸ”¹ å­¸ç”Ÿé é¢
async function loadStudentPage(){
  studentPage.style.display="block";
  const userDoc=await db.collection("users").doc(currentUser.uid).get();
  const classId=userDoc.data().classId;
  if(!classId) return document.getElementById("questionList").innerText="å°šæœªåŠ å…¥ç­ç´š";
  const qSnap=await db.collection("questions").where("classId","==",classId).get();
  const list=document.getElementById("questionList");
  list.innerHTML="";
  qSnap.forEach(doc=>{
    const q=doc.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<h4>${q.title}</h4><p>${q.content}</p><small>${q.edu} - ${q.sub}</small>`;
    list.appendChild(div);
  });
}
</script>
</body>
</html>
