<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ClassQuest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
      width: 400px;
    }
    button {
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: 0.3s;
    }
    button:hover { background: #3367D6; }
    input, select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    h1 { font-size: 26px; margin-bottom: 20px; }
    .hidden { display: none; }
    #logoutBtn { background: #e74c3c; }
    #logoutBtn:hover { background: #c0392b; }
    .section {
      margin-top: 20px;
      text-align: left;
    }
  </style>
</head>
<body>

  <!-- 登入畫面 -->
  <div class="card" id="loginCard">
    <h1>ClassQuest</h1>
    <button id="loginBtn">使用 Google 登入</button>
  </div>

  <!-- 主畫面 -->
  <div class="card hidden" id="mainCard">
    <h1 id="welcomeText"></h1>
    <p id="roleText"></p>
    <div id="contentArea"></div>
    <button id="logoutBtn">登出</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
      authDomain: "classquest-419e1.firebaseapp.com",
      projectId: "classquest-419e1",
      storageBucket: "classquest-419e1.firebasestorage.app",
      messagingSenderId: "18905423391",
      appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
      measurementId: "G-0H7STZJVXS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const loginCard = document.getElementById("loginCard");
    const mainCard = document.getElementById("mainCard");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const welcomeText = document.getElementById("welcomeText");
    const roleText = document.getElementById("roleText");
    const contentArea = document.getElementById("contentArea");

    // 登入
    loginBtn.addEventListener("click", async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          await setDoc(userRef, { email: user.email, role: "student" });
        }
      } catch (e) {
        alert("登入失敗：" + e.message);
      }
    });

    // 登出
    logoutBtn.addEventListener("click", async () => { await signOut(auth); });

    // 狀態監聽
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        loginCard.classList.add("hidden");
        mainCard.classList.remove("hidden");
        welcomeText.textContent = `👋 歡迎，${user.displayName}`;
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        let role = "student";
        if (userSnap.exists()) role = userSnap.data().role;
        roleText.textContent = `您的身分：${role}`;
        loadUI(role, user);
      } else {
        loginCard.classList.remove("hidden");
        mainCard.classList.add("hidden");
        contentArea.innerHTML = "";
      }
    });

    // 根據身分載入介面
    async function loadUI(role, user) {
      contentArea.innerHTML = "";
      if (role === "admin") renderAdminUI();
      if (role === "teacher") renderTeacherUI(user);
      if (role === "student") renderStudentUI();
    }

    // 管理者介面
    function renderAdminUI() {
      contentArea.innerHTML = `
        <div class="section">
          <h3>用戶管理</h3>
          <input type="text" id="emailInput" placeholder="輸入 Gmail">
          <select id="roleSelect">
            <option value="student">學生</option>
            <option value="teacher">老師</option>
            <option value="admin">管理者</option>
          </select>
          <button id="setRoleBtn">設定</button>
        </div>`;
      document.getElementById("setRoleBtn").onclick = async () => {
        const email = document.getElementById("emailInput").value.trim();
        const newRole = document.getElementById("roleSelect").value;
        if (!email) return alert("請輸入 Gmail");
        const usersSnap = await getDocs(collection(db, "users"));
        let found = false;
        for (const docSnap of usersSnap.docs) {
          if (docSnap.data().email === email) {
            await updateDoc(doc(db, "users", docSnap.id), { role: newRole });
            alert("已更新角色");
            found = true;
            break;
          }
        }
        if (!found) alert("找不到該使用者");
      };
    }

    // 老師介面
    function renderTeacherUI(user) {
      contentArea.innerHTML = `
        <div class="section">
          <h3>建立班級</h3>
          <input type="text" id="className" placeholder="班級名稱">
          <button id="createClassBtn">建立</button>
        </div>
        <div class="section">
          <h3>出題系統</h3>
          <select id="levelSelect">
            <option value="">選擇學段</option>
            <option value="小學">國小</option>
            <option value="國中">國中</option>
            <option value="高中">高中</option>
          </select>
          <select id="subjectSelect">
            <option value="">選擇科目</option>
          </select>
          <textarea id="questionContent" rows="4" placeholder="輸入題目內容"></textarea>
          <button id="addQuestionBtn">出題</button>
        </div>
      `;

      const subjectSelect = document.getElementById("subjectSelect");
      const levelSelect = document.getElementById("levelSelect");
      levelSelect.addEventListener("change", () => {
        const level = levelSelect.value;
        let subjects = [];
        if (level === "小學") subjects = ["國語", "英文", "數學", "自然", "社會"];
        if (level === "國中") subjects = ["國語", "英文", "數學", "生物", "理化", "地科", "歷史", "地理", "公民"];
        if (level === "高中") subjects = ["國語", "英文", "數學", "生物", "物理", "化學", "地科", "歷史", "地理", "公民"];
        subjectSelect.innerHTML = `<option value="">選擇科目</option>` + subjects.map(s => `<option value="${s}">${s}</option>`).join("");
      });

      // 建立班級
      document.getElementById("createClassBtn").onclick = async () => {
        const name = document.getElementById("className").value.trim();
        if (!name) return alert("請輸入班級名稱");
        await addDoc(collection(db, "classes"), { name, teacher: user.uid });
        alert("班級建立成功！");
      };

      // 出題
      document.getElementById("addQuestionBtn").onclick = async () => {
        const level = levelSelect.value;
        const subject = subjectSelect.value;
        const content = document.getElementById("questionContent").value.trim();
        if (!level || !subject || !content) return alert("請完整填寫");
        await addDoc(collection(db, "questions"), { level, subject, content, teacher: user.uid });
        alert("出題成功！");
      };
    }

    // 學生介面
    function renderStudentUI() {
      contentArea.innerHTML = `<div class="section"><h3>待完成試卷</h3><p>老師出的題目將顯示在此。</p></div>`;
    }
  </script>
</body>
</html>
