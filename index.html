<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ClassQuest</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f8f9fc;
  text-align: center;
  margin: 0;
  padding: 20px;
}
.card {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  max-width: 600px;
  margin: 40px auto;
}
input, select, textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
}
button {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
}
button:hover { background: #3730a3; }
.flex-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
</style>
</head>
<body>

<!-- 🔹 登入畫面 -->
<div id="loginDiv" class="card">
  <h2>登入系統</h2>
  <p>請使用 Google 登入</p>
  <button id="googleLoginBtn">使用 Google 登入</button>
</div>

<!-- 🔹 老師頁面 -->
<div id="teacherPage" class="card" style="display:none;">
  <h2>班級管理</h2>
  <div class="flex-row">
    <input type="text" id="newClassName" placeholder="輸入班級名稱" style="width:200px;">
    <button id="createClassBtn">建立班級</button>
  </div>
  <h3>你的班級</h3>
  <ul id="classList" style="list-style:none; padding:0;"></ul>

  <!-- 班級內頁 -->
  <div id="classPageDiv" class="card" style="display:none;">
    <h3 id="classTitle"></h3>

    <div class="flex-row" style="margin-bottom:10px;">
      <input type="text" id="studentEmail" placeholder="學生 Gmail" style="width:200px;">
      <button id="addStudentBtn">新增學生</button>
    </div>

    <h3>出題系統</h3>
    <input type="text" id="questionTitle" placeholder="題目名稱" style="width:300px;"><br><br>
    <textarea id="questionContent" placeholder="題目內容" style="width:300px; height:100px;"></textarea><br><br>

    <div class="flex-row">
      <label>學制：</label>
      <select id="educationLevel" onchange="updateSubjects()">
        <option value="">請選擇學制</option>
        <option value="elementary">國小</option>
        <option value="junior">國中</option>
        <option value="senior">高中</option>
      </select>

      <label>科目：</label>
      <select id="subjectSelect">
        <option value="">請先選擇學制</option>
      </select>
    </div><br>

    <div class="flex-row">
      <label>出題對象：</label>
      <select id="questionTarget">
        <option value="all">全班</option>
        <option value="individual">個人</option>
      </select>
    </div><br>

    <button id="saveQuestionBtn">儲存題目</button>
  </div>
</div>

<!-- 🔹 學生頁面 -->
<div id="studentPage" class="card" style="display:none;">
  <h2>題目列表</h2>
  <div id="questionList"></div>
</div>

<!-- 🔹 管理者頁面 -->
<div id="adminPage" class="card" style="display:none;">
  <h2>用戶管理</h2>
  <div class="flex-row">
    <input type="email" id="manageEmail" placeholder="輸入 Gmail">
    <select id="roleSelect">
      <option value="student">學生</option>
      <option value="teacher">老師</option>
      <option value="admin">管理者</option>
    </select>
    <button id="setRoleBtn">設定</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentClassId = null;

// 🔹 Google 登入
document.getElementById("googleLoginBtn").addEventListener("click", async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    const result = await auth.signInWithPopup(provider);
    const user = result.user;
    currentUser = user;
    const userRef = db.collection("users").doc(user.uid);
    const docSnap = await userRef.get();
    if(!docSnap.exists){
      await userRef.set({
        email: user.email,
        role: "student"
      });
    }
    loadRole();
  } catch (e) {
    alert("登入失敗：" + e.message);
  }
});

// 🔹 讀取角色
async function loadRole(){
  const userDoc = await db.collection("users").doc(currentUser.uid).get();
  if(!userDoc.exists) return alert("找不到使用者資料");
  const role = userDoc.data().role;
  loginDiv.style.display = "none";
  if(role === "teacher") loadTeacherPage();
  else if(role === "admin") loadAdminPage();
  else loadStudentPage();
}

// 🔹 管理者頁面
function loadAdminPage(){
  adminPage.style.display = "block";
  document.getElementById("setRoleBtn").onclick = async ()=>{
    const email = manageEmail.value.trim();
    const role = roleSelect.value;
    if(!email) return alert("請輸入 Gmail");
    const users = await db.collection("users").where("email","==",email).get();
    if(users.empty) return alert("找不到該帳號");
    users.forEach(doc=>{
      db.collection("users").doc(doc.id).update({role});
    });
    alert("設定完成！");
  };
}

// 🔹 老師頁面
function loadTeacherPage(){
  teacherPage.style.display = "block";
  loadTeacherClasses();
}

// 建立班級
createClassBtn.addEventListener("click", async ()=>{
  const name = newClassName.value.trim();
  if(!name) return alert("請輸入班級名稱");
  await db.collection("classes").add({
    name,
    teacherId: currentUser.uid
  });
  alert("班級建立成功");
  loadTeacherClasses();
  newClassName.value="";
});

// 載入老師班級
async function loadTeacherClasses(){
  classList.innerHTML = "";
  const snap = await db.collection("classes").where("teacherId","==",currentUser.uid).get();
  snap.forEach(doc=>{
    const li = document.createElement("li");
    li.innerHTML = `<button onclick="openClass('${doc.id}','${doc.data().name}')">${doc.data().name}</button>`;
    classList.appendChild(li);
  });
}

// 開啟班級
function openClass(id,name){
  currentClassId = id;
  classPageDiv.style.display="block";
  classTitle.innerText=name;
}

// 新增學生
addStudentBtn.addEventListener("click", async ()=>{
  const email = studentEmail.value.trim();
  if(!email) return alert("請輸入學生 Gmail");
  const snap = await db.collection("users").where("email","==",email).get();
  if(snap.empty) return alert("找不到該帳號");
  snap.forEach(doc=>{
    db.collection("users").doc(doc.id).update({classId:currentClassId});
  });
  alert("學生已加入班級！");
  studentEmail.value="";
});

// 學制科目
function updateSubjects(){
  const edu = educationLevel.value;
  const map = {
    elementary:["國語","英文","數學","自然","社會"],
    junior:["國語","英文","數學","生物","理化","地科","歷史","地理","公民"],
    senior:["國語","英文","數學","生物","物理","化學","地科","歷史","地理","公民"]
  };
  subjectSelect.innerHTML = "";
  if(!map[edu]) return subjectSelect.innerHTML=`<option>請先選學制</option>`;
  map[edu].forEach(s=>{
    const opt=document.createElement("option");
    opt.value=s; opt.textContent=s;
    subjectSelect.appendChild(opt);
  });
}

// 儲存題目
saveQuestionBtn.addEventListener("click", async ()=>{
  const title=questionTitle.value.trim();
  const content=questionContent.value.trim();
  const edu=educationLevel.value;
  const sub=subjectSelect.value;
  const target=questionTarget.value;
  if(!title||!content||!edu||!sub) return alert("請完整填寫");
  await db.collection("questions").add({
    title,content,edu,sub,target,
    teacherId:currentUser.uid,classId:currentClassId,
    timestamp:Date.now()
  });
  alert("題目已儲存");
  questionTitle.value = questionContent.value="";
});

// 🔹 學生頁面
async function loadStudentPage(){
  studentPage.style.display="block";
  const userDoc=await db.collection("users").doc(currentUser.uid).get();
  const classId=userDoc.data().classId;
  if(!classId) return document.getElementById("questionList").innerText="尚未加入班級";
  const qSnap=await db.collection("questions").where("classId","==",classId).get();
  const list=document.getElementById("questionList");
  list.innerHTML="";
  qSnap.forEach(doc=>{
    const q=doc.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<h4>${q.title}</h4><p>${q.content}</p><small>${q.edu} - ${q.sub}</small>`;
    list.appendChild(div);
  });
}
</script>
</body>
</html>
