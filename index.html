<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuizNova 系統</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; padding:20px; background:#f5f5f5; }
  h1,h2,h3,h4 { margin:10px; }
  button, input, select, textarea { margin:5px; padding:8px; font-size:14px; }
  #loginDiv, #mainPage { margin:20px auto; max-width:600px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  ul { list-style:none; padding:0; }
  li { margin:5px 0; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h1>QuizNova 答題系統</h1>

<div id="loginDiv">
  <button id="googleSignIn">使用 Google 登入</button>
</div>

<div id="mainPage" style="display:none;">
  <h2 id="welcomeMsg"></h2>

  <!-- 管理者頁面 -->
  <div id="adminPage" style="display:none;">
    <h3>用戶管理</h3>
    <input type="email" id="newUserEmail" placeholder="輸入 Gmail">
    <select id="newUserRole">
      <option value="student">學生</option>
      <option value="teacher">老師</option>
      <option value="admin">管理者</option>
    </select>
    <button onclick="createUser()">設定</button>
    <ul id="userList"></ul>

    <h3>班級管理</h3>
    <input type="text" id="newClassName" placeholder="班級名稱">
    <select id="assignTeacher"></select>
    <button onclick="createClass()">建立班級</button>
    <ul id="allClassList"></ul>
  </div>

  <!-- 老師頁面 -->
  <div id="teacherPage" style="display:none;">
    <h3>班級列表</h3>
    <ul id="classList"></ul>

    <h3>出題系統</h3>
    <input type="text" id="questionTitle" placeholder="題目名稱"><br>
    <textarea id="questionContent" placeholder="題目內容"></textarea><br>
    <input type="text" id="optionA" placeholder="選項A">
    <input type="text" id="optionB" placeholder="選項B">
    <input type="text" id="optionC" placeholder="選項C">
    <input type="text" id="optionD" placeholder="選項D"><br>
    正確答案：
    <select id="correctAnswer">
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
    </select><br>
    解釋：
    <textarea id="explanation" placeholder="答案解釋"></textarea><br>
    學段：
    <select id="gradeLevel">
      <option value="elementary">國小</option>
      <option value="junior">國中</option>
      <option value="senior">高中</option>
    </select>
    科目：
    <select id="subject">
      <option value="chinese">國語</option>
      <option value="english">英文</option>
      <option value="math">數學</option>
      <option value="biology">生物</option>
      <option value="physics">物理</option>
      <option value="chemistry">化學</option>
      <option value="history">歷史</option>
      <option value="geography">地理</option>
      <option value="civics">公民</option>
      <option value="nature">自然</option>
      <option value="society">社會</option>
    </select><br>
    <button onclick="saveQuestion()">儲存題目</button>
  </div>

  <!-- 學生頁面 -->
  <div id="studentPage" style="display:none;">
    <h3>你的試卷</h3>
    <ul id="studentTestsList"></ul>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginDiv = document.getElementById('loginDiv');
const mainPage = document.getElementById('mainPage');
const welcomeMsg = document.getElementById('welcomeMsg');
const studentPage = document.getElementById('studentPage');
const teacherPage = document.getElementById('teacherPage');
const adminPage = document.getElementById('adminPage');

// 登入
document.getElementById('googleSignIn').addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    const user = result.user;
    checkUser(user);
  });
});

// 檢查用戶角色
function checkUser(user) {
  loginDiv.style.display = "none";
  mainPage.style.display = "block";
  db.collection("users").doc(user.uid).get().then(doc => {
    if(!doc.exists) {
      db.collection("users").doc(user.uid).set({
        name: user.displayName,
        email: user.email,
        role: "student"
      });
    }
    const role = doc.exists ? doc.data().role : "student";
    welcomeMsg.innerText = `歡迎 ${user.displayName} (${role})`;

    if(role === "admin") loadAdminPage();
    else if(role === "teacher") loadTeacherPage(user.uid);
    else loadStudentPage(user.uid);
  });
}

// ---------------- 管理者 ----------------
function loadAdminPage() {
  adminPage.style.display = "block";
  loadUsers();
  loadAllClasses();
  loadTeachersForAssign();
}

function loadUsers() {
  db.collection("users").get().then(snapshot => {
    const ul = document.getElementById("userList");
    ul.innerHTML = "";
    snapshot.forEach(doc => {
      const user = doc.data();
      const li = document.createElement("li");
      li.innerHTML = `${user.name} (${user.email}) - ${user.role}`;
      ul.appendChild(li);
    });
  });
}

function createUser() {
  const email = document.getElementById('newUserEmail').value;
  const role = document.getElementById('newUserRole').value;
  if(!email) return alert("請輸入 Gmail");
  // 這裡假設管理者事先通知用戶用 Google 登入
  db.collection("users").add({name:"",email,role});
  alert("用戶已新增");
  loadUsers();
}

function loadAllClasses() {
  db.collection("classes").get().then(snapshot => {
    const ul = document.getElementById("allClassList");
    ul.innerHTML = "";
    snapshot.forEach(doc => ul.innerHTML += `<li>${doc.data().name} - 老師: ${doc.data().teacherName||''}</li>`);
  });
}

function loadTeachersForAssign() {
  db.collection("users").where("role","==","teacher").get().then(snapshot=>{
    const select = document.getElementById("assignTeacher");
    select.innerHTML = "";
    snapshot.forEach(doc=>{
      const t = doc.data();
      select.innerHTML += `<option value="${doc.id}">${t.name} (${t.email})</option>`;
    });
  });
}

function createClass() {
  const name = document.getElementById('newClassName').value;
  const teacherId = document.getElementById('assignTeacher').value;
  if(!name) return alert("請輸入班級名稱");
  db.collection("users").doc(teacherId).get().then(tdoc=>{
    const teacherName = tdoc.data().name;
    db.collection("classes").add({name,teacherId,teacherName}).then(()=>{
      alert("班級建立完成");
      document.getElementById('newClassName').value="";
      loadAllClasses();
    });
  });
}

// ---------------- 老師 ----------------
function loadTeacherPage(uid){
  teacherPage.style.display = "block";
  const classList = document.getElementById('classList');
  db.collection("classes").where("teacherId","==",uid).get().then(snapshot=>{
    classList.innerHTML="";
    snapshot.forEach(doc=>{
      const li = document.createElement("li");
      li.innerText = doc.data().name;
      classList.appendChild(li);
    });
  });
}

function saveQuestion(){
  const title=document.getElementById('questionTitle').value;
  const content=document.getElementById('questionContent').value;
  const optionA=document.getElementById('optionA').value;
  const optionB=document.getElementById('optionB').value;
  const optionC=document.getElementById('optionC').value;
  const optionD=document.getElementById('optionD').value;
  const correct=document.getElementById('correctAnswer').value;
  const explanation=document.getElementById('explanation').value;
  const grade=document.getElementById('gradeLevel').value;
  const subject=document.getElementById('subject').value;

  if(!title||!content||!optionA||!optionB||!optionC||!optionD) return alert("請填完整題目與選項");

  const user = auth.currentUser;
  db.collection("questions").add({
    title, content,
    options:{A:optionA,B:optionB,C:optionC,D:optionD},
    correct, explanation,
    grade, subject,
    teacherId:user.uid,
    timestamp:Date.now()
  }).then(()=>{
    alert("題目已儲存");
    // 清空表單
    document.getElementById('questionTitle').value="";
    document.getElementById('questionContent').value="";
    document.getElementById('optionA').value="";
    document.getElementById('optionB').value="";
    document.getElementById('optionC').value="";
    document.getElementById('optionD').value="";
    document.getElementById('explanation').value="";
  });
}

// ---------------- 學生 ----------------
function loadStudentPage(uid){
  studentPage.style.display="block";
  db.collection("questions").get().then(snapshot=>{
    const ul=document.getElementById("studentTestsList");
    ul.innerHTML="";
    snapshot.forEach(doc=>{
      const q=doc.data();
      ul.innerHTML+=`<li>${q.title} - ${q.content}</li>`;
    });
  });
}
</script>
</body>
</html>
