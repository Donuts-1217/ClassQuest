<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassQuest AIlead/Likedu ç³»çµ±</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:"Segoe UI",sans-serif;background:#f5f6fa;display:flex;justify-content:center;padding:20px;}
.card{background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);width:720px;padding:30px;text-align:center;margin-bottom:20px;}
button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:8px;background:#4285F4;color:#fff;cursor:pointer;font-size:16px;}
button:hover{background:#3367D6;}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;}
ul{list-style:none;padding:0;}
li{padding:8px;background:#f8f9fa;margin:6px 0;border-radius:8px;cursor:pointer;}
li:hover{background:#e2e6ea;}
.hidden{display:none;}
.section{margin-top:20px;text-align:left;}
textarea{resize:none;}
.option-btn{margin-top:5px;width:48%;margin-right:2%;}
.correct{color:green;font-weight:bold;}
.wrong{color:red;font-weight:bold;}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1>ClassQuest AIlead / Likedu</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div class="card hidden" id="mainCard">
  <h2 id="welcomeText"></h2>
  <button id="logoutBtn">ç™»å‡º</button>
  <div id="contentArea"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain:"classquest-419e1.firebaseapp.com",
  projectId:"classquest-419e1",
  storageBucket:"classquest-419e1.firebasestorage.app",
  messagingSenderId:"18905423391",
  appId:"1:18905423391:web:37c3aa41f021430"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginCard=document.getElementById("loginCard");
const mainCard=document.getElementById("mainCard");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const welcomeText=document.getElementById("welcomeText");
const contentArea=document.getElementById("contentArea");

// ç™»å…¥ç™»å‡º
loginBtn.addEventListener("click", async ()=>{
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      // é è¨­å­¸ç”Ÿ
      await setDoc(userRef,{email:user.email,name:user.displayName,role:"student",classId:null});
    }
  }catch(e){alert("ç™»å…¥å¤±æ•—ï¼š"+e.message);}
});
logoutBtn.addEventListener("click", async ()=>{await signOut(auth);});

// ç›£è½ç™»å…¥ç‹€æ…‹
onAuthStateChanged(auth, async user=>{
  if(user){
    loginCard.classList.add("hidden");
    mainCard.classList.remove("hidden");
    welcomeText.textContent=`ğŸ‘‹ æ­¡è¿ï¼Œ${user.displayName}`;
    const userSnap = await getDoc(doc(db,"users",user.uid));
    const role = userSnap.data().role;
    if(role==="teacher") renderTeacherUI(user);
    else if(role==="admin") renderAdminUI(user);
    else renderStudentUI(user);
  }else{
    loginCard.classList.remove("hidden");
    mainCard.classList.add("hidden");
    contentArea.innerHTML="";
  }
});

// ---------------- è€å¸« UI ----------------
async function renderTeacherUI(user){
  contentArea.innerHTML=`
  <div class="section">
    <h3>æ–°å¢é¸æ“‡é¡Œ</h3>
    <textarea id="questionContent" rows="2" placeholder="é¡Œç›®å…§å®¹"></textarea>
    <input type="text" id="optA" placeholder="é¸é … A">
    <input type="text" id="optB" placeholder="é¸é … B">
    <input type="text" id="optC" placeholder="é¸é … C">
    <input type="text" id="optD" placeholder="é¸é … D">
    <select id="correctAnswer">
      <option value="">é¸æ“‡æ­£ç¢ºç­”æ¡ˆ</option>
      <option value="A">A</option><option value="B">B</option>
      <option value="C">C</option><option value="D">D</option>
    </select>
    <textarea id="explanation" rows="2" placeholder="è§£é‡‹"></textarea>
    <button id="addQuestionBtn">å‡ºé¡Œ</button>
  </div>

  <div class="section">
    <h3>æŒ‡æ´¾è©¦å·</h3>
    <input type="text" id="assignClass" placeholder="ç­ç´šæˆ–å­¸ç”Ÿ Gmail">
    <select id="subjectSelect">
      <option value="elementary_chinese">åœ‹å°-åœ‹èª</option>
      <option value="elementary_english">åœ‹å°-è‹±æ–‡</option>
      <option value="elementary_math">åœ‹å°-æ•¸å­¸</option>
      <option value="elementary_science">åœ‹å°-è‡ªç„¶</option>
      <option value="elementary_social">åœ‹å°-ç¤¾æœƒ</option>
      <option value="junior_chinese">åœ‹ä¸­-åœ‹èª</option>
      <option value="junior_english">åœ‹ä¸­-è‹±æ–‡</option>
      <option value="junior_math">åœ‹ä¸­-æ•¸å­¸</option>
      <option value="junior_bio">åœ‹ä¸­-ç”Ÿç‰©</option>
      <option value="junior_chem">åœ‹ä¸­-ç†åŒ–</option>
      <option value="junior_geo">åœ‹ä¸­-åœ°ç§‘</option>
      <option value="junior_history">åœ‹ä¸­-æ­·å²</option>
      <option value="junior_geo2">åœ‹ä¸­-åœ°ç†</option>
      <option value="junior_civics">åœ‹ä¸­-å…¬æ°‘</option>
      <option value="senior_chinese">é«˜ä¸­-åœ‹èª</option>
      <option value="senior_english">é«˜ä¸­-è‹±æ–‡</option>
      <option value="senior_math">é«˜ä¸­-æ•¸å­¸</option>
      <option value="senior_bio">é«˜ä¸­-ç”Ÿç‰©</option>
      <option value="senior_physics">é«˜ä¸­-ç‰©ç†</option>
      <option value="senior_chem">é«˜ä¸­-åŒ–å­¸</option>
      <option value="senior_geo">é«˜ä¸­-åœ°ç§‘</option>
      <option value="senior_history">é«˜ä¸­-æ­·å²</option>
      <option value="senior_geo2">é«˜ä¸­-åœ°ç†</option>
      <option value="senior_civics">é«˜ä¸­-å…¬æ°‘</option>
    </select>
    <input type="number" id="numQuestions" placeholder="é¡Œæ•¸" min="1">
    <button id="assignBtn">æŒ‡æ´¾è©¦å·</button>
  </div>
  `;

  document.getElementById("addQuestionBtn").onclick=async ()=>{
    const content=document.getElementById("questionContent").value.trim();
    const optA=document.getElementById("optA").value.trim();
    const optB=document.getElementById("optB").value.trim();
    const optC=document.getElementById("optC").value.trim();
    const optD=document.getElementById("optD").value.trim();
    const correct=document.getElementById("correctAnswer").value;
    const explanation=document.getElementById("explanation").value.trim();
    if(!content||!optA||!optB||!optC||!optD||!correct) return alert("è«‹å®Œæ•´å¡«å¯«é¡Œç›®èˆ‡é¸é …");
    await addDoc(collection(db,"questions"),{content,optA,optB,optC,optD,correctAnswer:correct,explanation,teacherId:user.uid});
    // è‡ªå‹•æ¸…ç©º
    document.getElementById("questionContent").value="";
    document.getElementById("optA").value="";
    document.getElementById("optB").value="";
    document.getElementById("optC").value="";
    document.getElementById("optD").value="";
    document.getElementById("correctAnswer").value="";
    document.getElementById("explanation").value="";
    alert("é¡Œç›®æ–°å¢æˆåŠŸï¼");
  };

  document.getElementById("assignBtn").onclick=async ()=>{
    const assignTarget=document.getElementById("assignClass").value.trim();
    const subject=document.getElementById("subjectSelect").value;
    const numQ=parseInt(document.getElementById("numQuestions").value);
    if(!assignTarget || !numQ || numQ<1) return alert("è«‹å¡«å¯«å®Œæ•´");
    const qSnap = await getDocs(collection(db,"questions"));
    const questions=qSnap.docs.slice(0,numQ);
    for(const q of questions){
      await addDoc(collection(db,"answers"),{
        studentId:assignTarget,
        questionId:q.id,
        selected:null,
        correct:null,
        timestamp:Date.now(),
        subject
      });
    }
    alert("è©¦å·å·²æŒ‡æ´¾ï¼");
  };
}

// ---------------- ç®¡ç†è€… UI ----------------
async function renderAdminUI(user){
  contentArea.innerHTML=`
  <div class="section">
    <h3>ç®¡ç†ä½¿ç”¨è€…</h3>
    <input type="text" id="adminEmail" placeholder="è¼¸å…¥ Gmail">
    <select id="adminRole">
      <option value="student">å­¸ç”Ÿ</option>
      <option value="teacher">è€å¸«</option>
      <option value="admin">ç®¡ç†è€…</option>
    </select>
    <button id="setRoleBtn">è¨­å®šè§’è‰²</button>
  </div>`;
  
  document.getElementById("setRoleBtn").onclick=async ()=>{
    const email=document.getElementById("adminEmail").value.trim();
    const role=document.getElementById("adminRole").value;
    if(!email) return alert("è«‹è¼¸å…¥ Gmail");
    // æŸ¥è©¢ user
    const usersSnap = await getDocs(query(collection(db,"users"),where("email","==",email)));
    if(usersSnap.empty){
      await addDoc(collection(db,"users"),{email,name:email,role,classId:null});
    } else {
      usersSnap.forEach(async u=>{
        await setDoc(doc(db,"users",u.id),{email:name,role,classId:null},{merge:true});
      });
    }
    alert("è§’è‰²å·²è¨­å®šï¼");
  };
}

// ---------------- å­¸ç”Ÿ UI ----------------
async function renderStudentUI(user){
  contentArea.innerHTML=`
  <div class="section">
    <h3>å¯ä½œç­”é¡Œç›®</h3>
    <ul id="quizList"></ul>
    <button id="submitBtn">å®Œæˆè©¦å·ä¸¦æäº¤</button>
  </div>`;
  
  const ul=document.getElementById("quizList");
  const aSnap=await getDocs(query(collection(db,"answers"),where("studentId","==",user.email)));
  const myAnswers=aSnap.docs;
  
  for(const docAns of myAnswers){
    const qDoc=await getDoc(doc(db,"questions",docAns.data().questionId));
    const q=qDoc.data();
    const li=document.createElement("li");
    li.innerHTML=`${q.content}<br>
      <button class="option-btn">A:${q.optA}</button>
      <button class="option-btn">B:${q.optB}</button>
      <button class="option-btn">C:${q.optC}</button>
      <button class="option-btn">D:${q.optD}</button>`;
    const buttons=li.querySelectorAll("button.option-btn");
    buttons.forEach(btn=>{
      btn.onclick=async ()=>{
        await setDoc(doc(db,"answers",docAns.id),{
          ...docAns.data(),
          selected:btn.textContent[0],
          correct:null
        });
        buttons.forEach(b=>b.disabled=true);
      };
    });
    ul.appendChild(li);
  }

  document.getElementById("submitBtn").onclick=async ()=>{
    let correctCount=0;
    for(const docAns of myAnswers){
      const qDoc=await getDoc(doc(db,"questions",docAns.data().questionId));
      const q=qDoc.data();
      const selected=(await getDoc(doc(db,"answers",docAns.id))).data().selected;
      const isCorrect=selected===q.correctAnswer;
      if(isCorrect) correctCount++;
      await setDoc(doc(db,"answers",docAns.id),{...docAns.data(),correct:isCorrect});
    }
    const total=myAnswers.length;
    const score=(100/total)*correctCount;
    alert(`è©¦å·å®Œæˆï¼\nç­”å°ç‡:${(correctCount/total*100).toFixed(1)}%\nåˆ†æ•¸:${score.toFixed(1)}`);
  };
}
</script>
</body>
</html>
