<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassQuest è€å¸«ç³»çµ±</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
<style>
body {font-family:"Segoe UI",sans-serif;background:#f5f6fa;display:flex;justify-content:center;padding:30px 0;}
.card {background:#fff;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);width:480px;padding:30px;margin:15px auto;text-align:center;}
button {width:100%;padding:10px;margin-top:10px;border:none;border-radius:8px;background:#4285F4;color:#fff;cursor:pointer;font-size:16px;}
button:hover{background:#3367D6;}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;}
ul{list-style:none;padding:0;}
li{padding:8px;background:#f8f9fa;margin:6px 0;border-radius:8px;cursor:pointer;}
li:hover{background:#e2e6ea;}
.hidden{display:none;}
.section{margin-top:20px;text-align:left;}
textarea{resize:none;}
</style>
</head>
<body>

<div class="card" id="loginCard">
  <h1>ClassQuest è€å¸«ç³»çµ±</h1>
  <button id="loginBtn">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<div class="card hidden" id="mainCard">
  <h2 id="welcomeText"></h2>
  <p id="roleText"></p>
  <div id="contentArea"></div>
  <button id="logoutBtn">ç™»å‡º</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain:"classquest-419e1.firebaseapp.com",
  projectId:"classquest-419e1",
  storageBucket:"classquest-419e1.firebasestorage.app",
  messagingSenderId:"18905423391",
  appId:"1:18905423391:web:37c3aa41f021430f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginCard=document.getElementById("loginCard");
const mainCard=document.getElementById("mainCard");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const welcomeText=document.getElementById("welcomeText");
const roleText=document.getElementById("roleText");
const contentArea=document.getElementById("contentArea");

loginBtn.addEventListener("click", async ()=>{
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      await setDoc(userRef,{email:user.email,name:user.displayName,role:"teacher"});
    }
  }catch(e){alert("ç™»å…¥å¤±æ•—ï¼š"+e.message);}
});

logoutBtn.addEventListener("click", async ()=>{await signOut(auth);});

onAuthStateChanged(auth, async user=>{
  if(user){
    loginCard.classList.add("hidden");
    mainCard.classList.remove("hidden");
    welcomeText.textContent=`ğŸ‘‹ æ­¡è¿ï¼Œ${user.displayName}`;
    roleText.textContent="èº«åˆ†ï¼šè€å¸«";
    renderTeacherUI(user);
  }else{
    loginCard.classList.remove("hidden");
    mainCard.classList.add("hidden");
    contentArea.innerHTML="";
  }
});

// ---------------- Teacher UI -----------------
async function renderTeacherUI(user){
  contentArea.innerHTML=`
    <div class="section">
      <h3>ç­ç´šç®¡ç†</h3>
      <input type="text" id="className" placeholder="è¼¸å…¥ç­ç´šåç¨±">
      <button id="createClassBtn">å»ºç«‹ç­ç´š</button>
      <ul id="classList"></ul>
    </div>

    <div id="classSection" class="section hidden">
      <h3 id="classTitle"></h3>
      <input type="text" id="studentEmail" placeholder="å­¸ç”Ÿ Gmail">
      <button id="addStudentBtn">æ–°å¢å­¸ç”Ÿ</button>
      <ul id="studentList"></ul>
      
      <div class="section">
        <h4>æŒ‡æ´¾è©¦å·</h4>
        <select id="levelSelect">
          <option value="">é¸æ“‡å­¸æ®µ</option>
          <option value="åœ‹å°">åœ‹å°</option>
          <option value="åœ‹ä¸­">åœ‹ä¸­</option>
          <option value="é«˜ä¸­">é«˜ä¸­</option>
        </select>
        <select id="subjectSelect"><option value="">é¸æ“‡ç§‘ç›®</option></select>
        <input type="number" id="questionCount" placeholder="é¡Œæ•¸">
        <button id="assignBtn">æŒ‡æ´¾è©¦å·</button>
      </div>

      <div class="section">
        <h4>æ–°å¢é¡Œç›®</h4>
        <textarea id="questionContent" rows="3" placeholder="é¡Œç›®å…§å®¹"></textarea>
        <input type="text" id="correctAnswer" placeholder="æ­£ç¢ºç­”æ¡ˆ">
        <textarea id="explanation" rows="2" placeholder="è§£é‡‹"></textarea>
        <button id="addQuestionBtn">å‡ºé¡Œ</button>
      </div>
    </div>
  `;

  const classList=document.getElementById("classList");
  const classSection=document.getElementById("classSection");
  let currentClassId="";

  document.getElementById("createClassBtn").onclick=async ()=>{
    const name=document.getElementById("className").value.trim();
    if(!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
    const docRef=await addDoc(collection(db,"classes"),{name,teacherId:user.uid});
    currentClassId=docRef.id;
    alert("ç­ç´šå»ºç«‹æˆåŠŸï¼");
    loadClasses();
  };

  async function loadClasses(){
    classList.innerHTML="";
    const q=query(collection(db,"classes"),where("teacherId","==",user.uid));
    const snapshot=await getDocs(q);
    snapshot.forEach(docSnap=>{
      const li=document.createElement("li");
      li.textContent=docSnap.data().name;
      li.onclick=()=>{currentClassId=docSnap.id; openClass(docSnap.data().name);};
      classList.appendChild(li);
    });
  }

  function openClass(name){
    classSection.classList.remove("hidden");
    document.getElementById("classTitle").textContent=name;
    loadStudents();
  }

  async function loadStudents(){
    const ul=document.getElementById("studentList");
    ul.innerHTML="";
    const snapshot=await getDocs(collection(db,"users"));
    snapshot.forEach(docSnap=>{
      const u=docSnap.data();
      if(u.classId===currentClassId){
        const li=document.createElement("li");
        li.textContent=`${u.name} (${u.email})`;
        ul.appendChild(li);
      }
    });
  }

  document.getElementById("addStudentBtn").onclick=async ()=>{
    const email=document.getElementById("studentEmail").value.trim();
    if(!email) return alert("è«‹è¼¸å…¥ Gmail");
    await addDoc(collection(db,"users"),{email,name:"å­¸ç”Ÿ",role:"student",classId:currentClassId});
    alert("å­¸ç”Ÿæ–°å¢æˆåŠŸï¼");
    loadStudents();
  };

  document.getElementById("levelSelect").addEventListener("change",()=>{
    const level=document.getElementById("levelSelect").value;
    let subjects=[];
    if(level==="åœ‹å°") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","è‡ªç„¶","ç¤¾æœƒ"];
    if(level==="åœ‹ä¸­") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç†åŒ–","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"];
    if(level==="é«˜ä¸­") subjects=["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç‰©ç†","åŒ–å­¸","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"];
    document.getElementById("subjectSelect").innerHTML=`<option value="">é¸æ“‡ç§‘ç›®</option>`+subjects.map(s=>`<option value="${s}">${s}</option>`).join("");
  });

  document.getElementById("addQuestionBtn").onclick=async ()=>{
    const content=document.getElementById("questionContent").value.trim();
    const correct=document.getElementById("correctAnswer").value.trim();
    const explanation=document.getElementById("explanation").value.trim();
    if(!content||!correct||!explanation) return alert("è«‹å®Œæ•´å¡«å¯«é¡Œç›®ã€ç­”æ¡ˆã€è§£é‡‹");
    await addDoc(collection(db,"questions"),{
      content,correctAnswer:correct,explanation,teacherId:user.uid,classId:currentClassId,
      timestamp:Date.now()
    });
    alert("é¡Œç›®å‡ºé¡ŒæˆåŠŸï¼");
    document.getElementById("questionContent").value="";
    document.getElementById("correctAnswer").value="";
    document.getElementById("explanation").value="";
  };

  document.getElementById("assignBtn").onclick=async ()=>{
    const level=document.getElementById("levelSelect").value;
    const subject=document.getElementById("subjectSelect").value;
    const count=parseInt(document.getElementById("questionCount").value);
    if(!level||!subject||!count) return alert("è«‹å®Œæ•´é¸æ“‡ç¯„åœèˆ‡é¡Œæ•¸");
    alert(`å·²æŒ‡æ´¾ ${count} é¡Œ ${level} ${subject} çµ¦ç­ç´š`);
    // é€™è£¡å¯æŠŠé¡Œç›®éš¨æ©ŸæŒ‘é¸ count é¡Œå„²å­˜åˆ° classId å°æ‡‰å­¸ç”Ÿè©¦å·
  };

  loadClasses();
}
</script>
</body>
</html>
