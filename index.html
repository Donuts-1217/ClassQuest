<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuizNova 系統</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; display:flex; flex-direction:column; align-items:center; margin:0; padding:0; background:#f0f2f5;}
h1,h2,h3,h4 { margin:5px 0;}
#loginDiv, #mainPage { margin-top:50px; width:90%; max-width:900px; text-align:center;}
button { padding:10px 20px; margin:5px; cursor:pointer;}
input, select, textarea { padding:5px; margin:5px; width:90%; box-sizing:border-box;}
.card { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
ul { list-style:none; padding:0;}
li { margin:5px 0; }
</style>
</head>
<body>

<h1>QuizNova 答題系統</h1>

<div id="loginDiv">
  <button id="googleSignIn">使用 Google 登入</button>
</div>

<div id="mainPage" style="display:none;">
  <h2 id="welcomeMsg"></h2>

  <!-- 管理者頁面 -->
  <div id="adminPage" style="display:none;" class="card">
    <h3>用戶管理</h3>
    <input type="email" id="newUserEmail" placeholder="輸入 Gmail">
    <select id="newUserRole">
      <option value="student">學生</option>
      <option value="teacher">老師</option>
      <option value="admin">管理者</option>
    </select>
    <button onclick="addUser()">新增 / 設定角色</button>
    <ul id="userList"></ul>

    <h3>全縣班級</h3>
    <ul id="allClassList"></ul>
  </div>

  <!-- 老師頁面 -->
  <div id="teacherPage" style="display:none;" class="card">
    <h3>班級管理</h3>
    <button onclick="showCreateClass()">建立班級</button>
    <div id="createClassDiv" style="display:none;">
      <input type="text" id="newClassName" placeholder="班級名稱">
      <button onclick="createClass()">建立</button>
    </div>
    <ul id="classList"></ul>

    <div id="classPageDiv" style="display:none;" class="card">
      <h4 id="classTitle"></h4>
      <input type="email" id="studentEmail" placeholder="學生 Gmail">
      <button onclick="addStudent()">新增學生</button>

      <h4>出題系統</h4>
      <select id="selectLevel">
        <option value="">選擇學段</option>
        <option value="elementary">國小</option>
        <option value="junior">國中</option>
        <option value="senior">高中</option>
      </select>
      <select id="selectSubject">
        <option value="">先選學段</option>
      </select>
      <input type="text" id="questionTitle" placeholder="題目">
      <textarea id="questionContent" placeholder="題目內容"></textarea>
      <input type="text" id="optionA" placeholder="選項 A">
      <input type="text" id="optionB" placeholder="選項 B">
      <input type="text" id="optionC" placeholder="選項 C">
      <input type="text" id="optionD" placeholder="選項 D">
      <select id="correctOption">
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
      </select>
      <textarea id="explanation" placeholder="答案解釋"></textarea>
      <button onclick="saveQuestion()">儲存題目</button>
    </div>
  </div>

  <!-- 學生頁面 -->
  <div id="studentPage" style="display:none;" class="card">
    <h3>你的試卷</h3>
    <ul id="studentTestsList"></ul>
  </div>
</div>

<script>
// ---------- Firebase 設定 ----------
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ---------- DOM 元素 ----------
const loginDiv = document.getElementById('loginDiv');
const mainPage = document.getElementById('mainPage');
const welcomeMsg = document.getElementById('welcomeMsg');
const adminPage = document.getElementById('adminPage');
const teacherPage = document.getElementById('teacherPage');
const studentPage = document.getElementById('studentPage');

const selectLevel = document.getElementById('selectLevel');
const selectSubject = document.getElementById('selectSubject');

// ---------- 學段與科目 ----------
const schoolLevels = {
  "elementary": ["國語","英文","數學","自然","社會","程式"],
  "junior": ["國語","英文","數學","生物","理化","地科","歷史","地理","公民","程式"],
  "senior": ["國語","英文","數學","生物","物理","化學","地科","歷史","地理","公民","程式"]
};
selectLevel.addEventListener('change',()=>{
  const level = selectLevel.value;
  selectSubject.innerHTML='<option value="">選擇科目</option>';
  if(schoolLevels[level]){
    schoolLevels[level].forEach(s=> selectSubject.innerHTML+=`<option value="${s}">${s}</option>`);
  }
});

// ---------- Google 登入 ----------
document.getElementById('googleSignIn').addEventListener('click',()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result=>{
    const user=result.user;
    loginDiv.style.display='none';
    mainPage.style.display='block';
    db.collection("users").doc(user.uid).get().then(doc=>{
      if(!doc.exists){
        db.collection("users").doc(user.uid).set({name:user.displayName,email:user.email,role:"student",classId:null});
      }
      const role = doc.exists ? doc.data().role : "student";
      welcomeMsg.innerText=`歡迎 ${user.displayName} (${role})`;
      if(role==="admin") loadAdminPage();
      else if(role==="teacher") loadTeacherPage(user.uid);
      else loadStudentPage(user.uid);
    });
  });
});

// ---------- 管理者功能 ----------
function loadAdminPage(){
  adminPage.style.display='block';
  loadUsers();
  loadAllClasses();
}
function addUser(){
  const email=document.getElementById('newUserEmail').value;
  const role=document.getElementById('newUserRole').value;
  if(!email) return alert("請輸入 Gmail");
  db.collection("users").add({email,role});
  alert("已新增/設定角色");
}
function loadUsers(){
  db.collection("users").get().then(snapshot=>{
    const ul=document.getElementById('userList');
    ul.innerHTML="";
    snapshot.forEach(doc=>{
      const u=doc.data();
      ul.innerHTML+=`<li>${u.email} - ${u.role}</li>`;
    });
  });
}
function loadAllClasses(){
  db.collection("classes").get().then(snapshot=>{
    const ul=document.getElementById('allClassList');
    ul.innerHTML="";
    snapshot.forEach(doc=> ul.innerHTML+=`<li>${doc.data().name}</li>`);
  });
}

// ---------- 老師功能 ----------
let currentTeacherId="", currentClassId="";
const classList=document.getElementById('classList');
const createClassDiv=document.getElementById('createClassDiv');
const classPageDiv=document.getElementById('classPageDiv');

function loadTeacherPage(uid){
  teacherPage.style.display='block';
  currentTeacherId=uid;
  db.collection("classes").where("teacherId","==",uid).get().then(snapshot=>{
    classList.innerHTML="";
    snapshot.forEach(doc=>{
      const li=document.createElement("li");
      li.innerText=doc.data().name;
      li.onclick=()=>openClassPage(doc.id,doc.data().name);
      classList.appendChild(li);
    });
  });
}

function showCreateClass(){ createClassDiv.style.display='block'; }
function createClass(){
  const name=document.getElementById('newClassName').value;
  if(!name) return alert("請輸入班級名稱");
  db.collection("classes").add({name,teacherId:currentTeacherId}).then(doc=>{
    openClassPage(doc.id,name);
  });
  createClassDiv.style.display='none';
}
function openClassPage(classId,className){
  currentClassId=classId;
  classPageDiv.style.display='block';
  document.getElementById('classTitle').innerText=className;
}
function addStudent(){
  const email=document.getElementById('studentEmail').value;
  if(!email) return alert("請輸入學生 Gmail");
  db.collection("users").add({email,role:"student",classId:currentClassId});
  alert("已新增學生");
}
function saveQuestion(){
  const title=document.getElementById('questionTitle').value;
  const content=document.getElementById('questionContent').value;
  const A=document.getElementById('optionA').value;
  const B=document.getElementById('optionB').value;
  const C=document.getElementById('optionC').value;
  const D=document.getElementById('optionD').value;
  const correct=document.getElementById('correctOption').value;
  const explanation=document.getElementById('explanation').value;
  const level=selectLevel.value;
  const subject=selectSubject.value;
  if(!title||!content||!A||!B||!C||!D||!correct||!level||!subject) return alert("請完整填寫");
  db.collection("questions").add({
    teacherId:currentTeacherId, level, subject, title, content,
    options:{A,B,C,D}, correct, explanation, timestamp:Date.now()
  });
  // 清空輸入欄
  document.getElementById('questionTitle').value="";
  document.getElementById('questionContent').value="";
  document.getElementById('optionA').value="";
  document.getElementById('optionB').value="";
  document.getElementById('optionC').value="";
  document.getElementById('optionD').value="";
  document.getElementById('explanation').value="";
  alert("題目已儲存");
}

// ---------- 學生功能 ----------
function loadStudentPage(uid){
  studentPage.style.display="block";
  db.collection("questions").get().then(snapshot=>{
    const ul=document.getElementById('studentTestsList');
    ul.innerHTML="";
    snapshot.forEach(doc=>{
      const q=doc.data();
      const li=document.createElement("li");
      li.innerHTML=`<b>${q.title}</b> (${q.subject})<br>
        <button onclick="submitAnswer('${uid}','${doc.id}','A')">A</button>
        <button onclick="submitAnswer('${uid}','${doc.id}','B')">B</button>
        <button onclick="submitAnswer('${uid}','${doc.id}','C')">C</button>
        <button onclick="submitAnswer('${uid}','${doc.id}','D')">D</button>`;
      ul.appendChild(li);
    });
  });
}
function submitAnswer(studentId,questionId,selected){
  db.collection("answers").add({studentId,questionId,selected,timestamp:Date.now()});
  alert("已送出答案");
}
</script>

</body>
</html>
