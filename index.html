<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å‡ºé¡Œç³»çµ±æ•´åˆç‰ˆ</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f8f9fc;
  text-align: center;
  margin: 0;
  padding: 20px;
}
.card {
  background: #ffffff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  max-width: 600px;
  margin: 20px auto;
}
input, select, textarea {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  outline: none;
}
button {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
}
button:hover { background: #3730a3; }
.flex-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}
</style>
</head>
<body>

<!-- ğŸ”¹ ç™»å…¥ç•«é¢ -->
<div id="loginDiv" class="card">
  <h2>ç™»å…¥ç³»çµ±</h2>
  <input type="email" id="loginEmail" placeholder="Email"><br><br>
  <input type="password" id="loginPassword" placeholder="å¯†ç¢¼"><br><br>
  <button id="loginBtn">ç™»å…¥</button>
  <button id="registerBtn">è¨»å†Š</button>
</div>

<!-- ğŸ”¹ è€å¸«é é¢ -->
<div id="teacherPage" class="card" style="display:none;">
  <h2>ç­ç´šç®¡ç†</h2>

  <!-- å»ºç«‹ç­ç´š -->
  <div class="flex-row" style="margin-bottom:15px;">
    <input type="text" id="newClassName" placeholder="è¼¸å…¥ç­ç´šåç¨±" style="width:200px;">
    <button id="createClassBtn">å»ºç«‹ç­ç´š</button>
  </div>

  <!-- ç­ç´šåˆ—è¡¨ -->
  <h3>ä½ çš„ç­ç´š</h3>
  <ul id="classList" style="list-style:none; padding:0;"></ul>

  <!-- ç­ç´šå…§é  -->
  <div id="classPageDiv" class="card" style="display:none;">
    <h3 id="classTitle"></h3>

    <!-- æ–°å¢å­¸ç”Ÿ -->
    <div class="flex-row" style="margin-bottom:10px;">
      <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å" style="width:200px;">
      <button id="addStudentBtn">æ–°å¢å­¸ç”Ÿ</button>
    </div>

    <!-- å‡ºé¡Œç³»çµ± -->
    <h3>å‡ºé¡Œç³»çµ±</h3>
    <input type="text" id="questionTitle" placeholder="é¡Œç›®åç¨±" style="width:300px;"><br><br>
    <textarea id="questionContent" placeholder="é¡Œç›®å…§å®¹" style="width:300px; height:100px;"></textarea><br><br>

    <!-- å­¸åˆ¶èˆ‡ç§‘ç›® -->
    <div class="flex-row">
      <label>å­¸åˆ¶ï¼š</label>
      <select id="educationLevel" onchange="updateSubjects()">
        <option value="">è«‹é¸æ“‡å­¸åˆ¶</option>
        <option value="elementary">åœ‹å°</option>
        <option value="junior">åœ‹ä¸­</option>
        <option value="senior">é«˜ä¸­</option>
      </select>

      <label>ç§‘ç›®ï¼š</label>
      <select id="subjectSelect">
        <option value="">è«‹å…ˆé¸æ“‡å­¸åˆ¶</option>
      </select>
    </div><br>

    <!-- å‡ºé¡Œå°è±¡ -->
    <div class="flex-row">
      <label>å‡ºé¡Œå°è±¡ï¼š</label>
      <select id="questionTarget">
        <option value="all">å…¨ç­</option>
        <option value="individual">å€‹äºº</option>
      </select>
    </div><br>

    <button id="saveQuestionBtn">å„²å­˜é¡Œç›®</button>
  </div>
</div>

<!-- ğŸ”¹ å­¸ç”Ÿé é¢ -->
<div id="studentPage" class="card" style="display:none;">
  <h2>é¡Œç›®åˆ—è¡¨</h2>
  <div id="questionList"></div>
</div>

<!-- ğŸ”¹ Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

<script>
// ğŸ”§ Firebase åˆå§‹åŒ–
const firebaseConfig = {
  apiKey: "AIzaSyAoyNkowj728zWCh1s-jYsPANIwfjZx430",
  authDomain: "classquest-419e1.firebaseapp.com",
  projectId: "classquest-419e1",
  storageBucket: "classquest-419e1.firebasestorage.app",
  messagingSenderId: "18905423391",
  appId: "1:18905423391:web:37c3aa41f021430f27ff2a",
  measurementId: "G-0H7STZJVXS"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentClassId = null;

// ç™»å…¥
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const email = loginEmail.value;
  const pass = loginPassword.value;
  auth.signInWithEmailAndPassword(email, pass).then(res=>{
    currentUser = res.user;
    loadRole();
  }).catch(e=>alert("ç™»å…¥å¤±æ•—ï¼š" + e.message));
});

// è¨»å†Š
document.getElementById("registerBtn").addEventListener("click", ()=>{
  const email = loginEmail.value;
  const pass = loginPassword.value;
  auth.createUserWithEmailAndPassword(email, pass).then(res=>{
    db.collection("users").doc(res.user.uid).set({
      email,
      role: "student",
      name: email.split("@")[0]
    });
    alert("è¨»å†ŠæˆåŠŸï¼");
  }).catch(e=>alert("è¨»å†Šå¤±æ•—ï¼š" + e.message));
});

// åˆ¤æ–·èº«ä»½é€²å…¥ç•«é¢
function loadRole(){
  db.collection("users").doc(currentUser.uid).get().then(doc=>{
    if(!doc.exists) return alert("ç„¡æ­¤ä½¿ç”¨è€…è³‡æ–™");
    const role = doc.data().role;
    loginDiv.style.display = "none";
    if(role === "teacher") loadTeacherPage(currentUser.uid);
    else loadStudentPage(currentUser.uid);
  });
}

// ---------------- è€å¸«ç³»çµ± ----------------
const classList = document.getElementById('classList');
const classPageDiv = document.getElementById('classPageDiv');
const classTitle = document.getElementById('classTitle');

function loadTeacherPage(uid){
  teacherPage.style.display = "block";
  loadTeacherClasses(uid);
}

function loadTeacherClasses(uid){
  classList.innerHTML = "";
  db.collection("classes").where("teacherId","==",uid).get().then(snap=>{
    snap.forEach(doc=>{
      const li = document.createElement("li");
      li.innerHTML = `<button onclick="openClassPage('${doc.id}','${doc.data().name}')">${doc.data().name}</button>`;
      classList.appendChild(li);
    });
  });
}

// å»ºç«‹ç­ç´š
createClassBtn.addEventListener("click", ()=>{
  const name = newClassName.value.trim();
  if(!name) return alert("è«‹è¼¸å…¥ç­ç´šåç¨±");
  db.collection("classes").add({ name, teacherId: currentUser.uid }).then(()=>{
    alert("ç­ç´šå»ºç«‹æˆåŠŸ");
    loadTeacherClasses(currentUser.uid);
    newClassName.value = "";
  });
});

function openClassPage(id, name){
  currentClassId = id;
  classPageDiv.style.display = "block";
  classTitle.innerText = name;
}

// æ–°å¢å­¸ç”Ÿ
addStudentBtn.addEventListener("click", ()=>{
  const name = studentName.value.trim();
  if(!name) return alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
  db.collection("users").add({
    name, email:"", role:"student", classId: currentClassId
  }).then(()=>alert("å­¸ç”Ÿæ–°å¢æˆåŠŸ")).catch(e=>alert(e.message));
  studentName.value = "";
});

// å­¸åˆ¶ç§‘ç›®å‹•æ…‹
function updateSubjects(){
  const edu = educationLevel.value;
  const map = {
    elementary:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","è‡ªç„¶","ç¤¾æœƒ"],
    junior:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç†åŒ–","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"],
    senior:["åœ‹èª","è‹±æ–‡","æ•¸å­¸","ç”Ÿç‰©","ç‰©ç†","åŒ–å­¸","åœ°ç§‘","æ­·å²","åœ°ç†","å…¬æ°‘"]
  };
  subjectSelect.innerHTML = "";
  if(!map[edu]) return subjectSelect.innerHTML=`<option>è«‹å…ˆé¸å­¸åˆ¶</option>`;
  map[edu].forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    subjectSelect.appendChild(opt);
  });
}

// å„²å­˜é¡Œç›®
saveQuestionBtn.addEventListener("click", ()=>{
  const title = questionTitle.value.trim();
  const content = questionContent.value.trim();
  const edu = educationLevel.value;
  const sub = subjectSelect.value;
  const target = questionTarget.value;
  if(!title||!content||!edu||!sub) return alert("è«‹å®Œæ•´å¡«å¯«");
  db.collection("questions").add({
    title, content, edu, sub, target,
    teacherId: currentUser.uid, classId: currentClassId,
    timestamp: Date.now()
  }).then(()=>alert("é¡Œç›®å·²å„²å­˜"));
  questionTitle.value = questionContent.value = "";
});

// ---------------- å­¸ç”Ÿç³»çµ± ----------------
function loadStudentPage(uid){
  studentPage.style.display = "block";
  db.collection("users").doc(uid).get().then(doc=>{
    const classId = doc.data().classId;
    if(!classId) return alert("å°šæœªåˆ†é…ç­ç´š");
    db.collection("questions").where("classId","==",classId).get().then(snap=>{
      const list = document.getElementById("questionList");
      list.innerHTML = "";
      snap.forEach(q=>{
        const d = q.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<h4>${d.title}</h4><p>${d.content}</p><small>${d.edu} - ${d.sub}</small>`;
        list.appendChild(div);
      });
    });
  });
}
</script>
</body>
</html>
